
<!DOCTYPE html>
<html lang="en">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Web development with asp.net and React.js">
    <title>Create a multitenant application with Entity Framework Code First - Part 2 - Web development with asp.net and React.js</title>
    <meta name="author" content="Babis Karypidis">
    
        <meta name="keywords" content="entity framework,multitenant,code first">
    
    
    
        
            <link rel="alternate" type="application/atom+xml" title="RSS" href="/atom.xml">
        
    
    <script type="application/ld+json">{"@context":"http://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Babis Karypidis","sameAs":["https://github.com/xabikos","http://stackoverflow.com/users/2326486/xabikos","https://twitter.com/xabikos","https://www.linkedin.com/in/charalamposkarypidis/","mailto:xaralaboskaripidis@gmail.com"],"image":"https://www.gravatar.com/avatar/7c9ee05396641133c8d505197fc17cc5"},"articleBody":"A short introductionIn continuation of Part 1 about creating a multitenant application with Entity Framework Code First we are going to see how we can use Interceptors to apply filtering when querying the data in a transparent way for our application. It is highly recommended to read the first part as this post assumes you are already familiar with the problem.\n\nThe idea behind this implementation came up based on two very nice projects in Github which try to give a generic solution to the filtering problem. The first project is called EntityFramework.Filters and it was the first one from Jimmy Bogard which has a NuGet package as well. The second very similar project which solved a couple of issues is EntityFramework.DynamicFilters from jcachat which also comes with a NuGet package. I have to highlight here that both of the projects give a wider solution to query filtering with Entity Framework and for our solution we are going to use just the general idea of filtering.\n\nEntity Framework interceptorsInterceptors is a very powerful mechanism that Entity Framework added in version 6 and allows us to write custom code and then injecting in the framework’s execution pipeline. We can use interceptors to extend or modify the functionality of Entity Framework. A very common scenario in to use interceptors for database activity logging as you can see in this example. For our purposes we will use interceptors to modify first all the query commands to the database and in the next part the insert, update and delete commands.\n\nThe command tree interceptorThe first step is to implement the IDbCommandTreeInterceptor and the TreeCreated method it declares, in order to take control of the query send to the database. The TenantCommandTreeInterceptor class is available below:\nQuery command Interceptorcspublic class TenantCommandTreeInterceptor : IDbCommandTreeInterceptor {\n    public void TreeCreated(DbCommandTreeInterceptionContext interceptionContext) {\n        if (interceptionContext.OriginalResult.DataSpace == DataSpace.SSpace) {\n            // Check that there is an authenticated user in this context\n            var identity = Thread.CurrentPrincipal.Identity as ClaimsIdentity;\n            if (identity == null){\n                return;\n            }\n            var userIdclaim = identity.Claims.SingleOrDefault(c =&gt; c.Type == ClaimTypes.NameIdentifier);\n            if (userIdclaim == null) {\n                return;\n            }\n            // In case of query command change the query by adding a filtering based on tenantId\n            var queryCommand = interceptionContext.Result as DbQueryCommandTree;\n            if (queryCommand != null) {\n                var newQuery = queryCommand.Query.Accept(new TenantQueryVisitor());\n                interceptionContext.Result = new DbQueryCommandTree(\n                    queryCommand.MetadataWorkspace,\n                    queryCommand.DataSpace,\n                    newQuery);\n                return;\n            }\n        }\n    }\n}\n\nI will try to explain the piece of code even though is not one of easiest concept in .net framework. A command tree in most cases is the equivalent of an expression tree that was created by a LINQ statement and Entity Framework can understand. In our case the query command tree is an object model representation of a query as is explained in the msdn documentation. If we would like to make it more clear a query command tree is an object representation of a SQL select statement with all required parameters.\nInitially we try to get the the identity of the user and verify that is logged in by getting the ClaimTypes.NameIdentifier. If the user is not logged we shouldn’t proceed with the interception as our requirement is to filter the data per user. The next few lines of code are relatively simple as we first examine if the command is a query command and if this is the case we continue with the interception. We create the new query which contains the filtering by applying the Visitor design pattern and the next step is to explicitly set the Result property of the interceptionContext by creating a new DbQueryCommandTree and return as the interception has done.\n\nThe TenantQueryVisitor classNow it’s time to see how the Query visitor class looks like.\nQuery expression visitorcspublic class TenantQueryVisitor: DefaultExpressionVisitor {\n    public override DbExpression Visit(DbScanExpression expression) {\n        var column = TenantAwareAttribute.GetTenantColumnName(expression.Target.ElementType);\n\n        if (!string.IsNullOrEmpty(column)) {\n            // Get the current expression\n            var dbExpression = base.Visit(expression);\n            // Get the current expression binding\n            var currentExpressionBinding = DbExpressionBuilder.Bind(dbExpression);\n            // Create the variable reference in order to create the property\n            var variableReference = DbExpressionBuilder.Variable(currentExpressionBinding.VariableType,\n                currentExpressionBinding.VariableName);\n            // Create the property based on the variable in order to apply the equality\n            var tenantProperty = DbExpressionBuilder.Property(variableReference, column);\n            // Create the parameter which is an object representation of a sql parameter.\n            // We have to create a parameter and not perform a direct comparison with Equal function for example\n            // as this logic is cached per query and called only once\n            var tenantParameter = DbExpressionBuilder.Parameter(tenantProperty.Property.TypeUsage,\n                TenantAwareAttribute.TenantIdFilterParameterName);\n            // Apply the equality between property and parameter.\n            var filterExpression = DbExpressionBuilder.Equal(tenantProperty, tenantParameter);\n            // Apply the filtering to the initial query\n            return DbExpressionBuilder.Filter(currentExpressionBinding, filterExpression);\n        }\n\n        return base.Visit(expression);\n    }\n}\n\nThe code here requires some knowledge of entity framework internals but I will try to explain it a bit more even though there are multiple comments in the code. What we are doing here is that we get the initial query and storing it in currentExpressionBinding variable. After doing this we create another expression which the SQL equivalent is “originalQuery AND TenantId &#x3D; @TenantIdParameter”. We could assign the value at this point and don’t use a SQL Parameter but this has a major problem as it’s highlighted in the comments. Internally Entity Framework caches the command tree by model as explained here so if we apply the filtering at this point we will get back always the data for the first user accessed the application something that obvious wrong. This implementation detail adds the need of implementing another interceptor, that is in a lower level, and assign the SQL parameter value we created inside visitor class.\n\nThe command interceptor classThe command interceptor class is shown below:\nCommand Interceptorcsinternal class TenantCommandInterceptor : IDbCommandInterceptor {\n    public void NonQueryExecuting(DbCommand command, DbCommandInterceptionContext&lt;int&gt; interceptionContext){\n        SetTenantParameterValue(command);\n    }\n\n    public void NonQueryExecuted(DbCommand command, DbCommandInterceptionContext&lt;int&gt; interceptionContext){}\n\n    public void ReaderExecuting(DbCommand command, DbCommandInterceptionContext&lt;DbDataReader&gt; interceptionContext){\n        SetTenantParameterValue(command);\n    }\n\n    public void ReaderExecuted(DbCommand command, DbCommandInterceptionContext&lt;DbDataReader&gt; interceptionContext){}\n\n    public void ScalarExecuting(DbCommand command, DbCommandInterceptionContext&lt;object&gt; interceptionContext){\n        SetTenantParameterValue(command);\n    }\n\n    public void ScalarExecuted(DbCommand command, DbCommandInterceptionContext&lt;object&gt; interceptionContext){}\n\n    private static void SetTenantParameterValue(DbCommand command) {\n        var identity = Thread.CurrentPrincipal.Identity as ClaimsIdentity;\n        if ((command == null) || (command.Parameters.Count == 0) || identity == null) {\n            return;\n        }\n        var userClaim = identity.Claims.SingleOrDefault(c =&gt; c.Type == ClaimTypes.NameIdentifier);\n        if (userClaim != null) {\n            var userId = userClaim.Value;\n            // Enumerate all command parameters and assign the correct value in the one we added inside query visitor\n            foreach (DbParameter param in command.Parameters) {\n                if (param.ParameterName != TenantAwareAttribute.TenantIdFilterParameterName)\n                    return;\n                param.Value = userId;\n            }\n        }\n    }\n}\n\nHere the logic is simpler as we just have to find the SQL Parameter if present and assign the correct value based on the user identity. The IDbCommandInterceptor contains six methods but in our use case we have to intercept only the ones executing before the command is sent to the database. I want to highlight here that is important how we access the required tenantId which in our case is the userId and we can find it from user’s identity. Now that async operations are very common this code could potentially executed by a thread that didn’t start the entire procedure so we have to make sure we can still access the required info.\n\nAdd interceptors in Entity Framework pipelineThe last step is to make Entity Framework aware of the interceptors we added before. To accomplish this we must use one of the latest addition in Framework the DbConfiguration class. We have to derive from this class and add the two interceptors as the code snippet below shows:\nEntity Framework Configurationcspublic class EntityFrameworkConfiguration : DbConfiguration {\n    public EntityFrameworkConfiguration() {\n        AddInterceptor(new TenantCommandInterceptor());\n        AddInterceptor(new TenantCommandTreeInterceptor());\n    }\n}\n\nThis class is very handy and powerful as we can do several configurations and is discovered automatically by Entity Framework. I want to note here that only one instance of a class deriving from DbConfiguration must exist per AppDomain.\n\nThis was the second part of a series of three posts. You can find the first part here. I have created a project in Github that contains the full code in a relatively change model. In the next post I will describe how we can use interceptors to modify the insert, update and delete command.\nPart 1Part 3","dateCreated":"2014-11-18T20:15:00+02:00","dateModified":"2024-04-20T18:01:58+03:00","datePublished":"2014-11-18T20:15:00+02:00","description":"A short introductionIn continuation of Part 1 about creating a multitenant application with Entity Framework Code First we are going to see how we can use Interceptors to apply filtering when querying the data in a transparent way for our application. It is highly recommended to read the first part as this post assumes you are already familiar with the problem.","headline":"Create a multitenant application with Entity Framework Code First - Part 2","image":[],"mainEntityOfPage":{"@type":"WebPage","@id":"https://xabikos.com/2014/11/18/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-2/"},"publisher":{"@type":"Organization","name":"Babis Karypidis","sameAs":["https://github.com/xabikos","http://stackoverflow.com/users/2326486/xabikos","https://twitter.com/xabikos","https://www.linkedin.com/in/charalamposkarypidis/","mailto:xaralaboskaripidis@gmail.com"],"image":"https://www.gravatar.com/avatar/7c9ee05396641133c8d505197fc17cc5","logo":{"@type":"ImageObject","url":"https://www.gravatar.com/avatar/7c9ee05396641133c8d505197fc17cc5"}},"url":"https://xabikos.com/2014/11/18/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-2/","keywords":"entity framework, multi-tenant, interceptors, code first"}</script>
    <meta name="description" content="A short introductionIn continuation of Part 1 about creating a multitenant application with Entity Framework Code First we are going to see how we can use Interceptors to apply filtering when querying">
<meta property="og:type" content="blog">
<meta property="og:title" content="Create a multitenant application with Entity Framework Code First - Part 2">
<meta property="og:url" content="https://xabikos.com/2014/11/18/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-2/index.html">
<meta property="og:site_name" content="Web development with asp.net and React.js">
<meta property="og:description" content="A short introductionIn continuation of Part 1 about creating a multitenant application with Entity Framework Code First we are going to see how we can use Interceptors to apply filtering when querying">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2014-11-18T18:15:00.000Z">
<meta property="article:modified_time" content="2024-04-20T15:01:58.567Z">
<meta property="article:author" content="Babis Karypidis">
<meta property="article:tag" content="entity framework">
<meta property="article:tag" content="multi-tenant">
<meta property="article:tag" content="interceptors">
<meta property="article:tag" content="code first">
<meta name="twitter:card" content="summary">
<meta name="twitter:creator" content="@xabikos">
    
    
        
    
    
        <meta property="og:image" content="https://www.gravatar.com/avatar/7c9ee05396641133c8d505197fc17cc5?s=640"/>
    
    
    
    
    <!--STYLES-->
    
<link rel="stylesheet" href="/assets/css/style-ivrygzl3rwlgzyajt80wrlhh1ioidhvuus4od2whngmbzmqtexp2vzrqzxtw.min.css">

    <!--STYLES END-->
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-56484404-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-56484404-1');
    </script>


    

    
        
    
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    
        
    

<header id="header" data-behavior="5">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a
            class="header-title-link"
            href="/"
            aria-label=""
        >
            Web development with asp.net and React.js
        </a>
    </div>
    
        
            <a
                class="header-right-picture "
                href="#about"
                aria-label="Open the link: /#about"
            >
        
        
            <img class="header-picture" src="https://www.gravatar.com/avatar/7c9ee05396641133c8d505197fc17cc5?s=90" alt="Author&#39;s picture"/>
        
        </a>
    
</header>

            <!-- Define author's picture -->


    

<nav id="sidebar" data-behavior="5">
    <div class="sidebar-container">
        
            <div class="sidebar-profile">
                <a
                    href="/#about"
                    aria-label="Read more about the author"
                >
                    <img class="sidebar-profile-picture" src="https://www.gravatar.com/avatar/7c9ee05396641133c8d505197fc17cc5?s=110" alt="Author&#39;s picture"/>
                </a>
                <h4 class="sidebar-profile-name">Babis Karypidis</h4>
                
                    <h5 class="sidebar-profile-bio"><p>Hi, I am Babis Karypidis, a Greek software engineer who tries to fit other activities, except development, in his life.</p>
</h5>
                
            </div>
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/"
                            
                            rel="noopener"
                            title="Home"
                        >
                        <i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Home</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-categories"
                            
                            rel="noopener"
                            title="Categories"
                        >
                        <i class="sidebar-button-icon fa fa-bookmark" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Categories</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-tags"
                            
                            rel="noopener"
                            title="Tags"
                        >
                        <i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Tags</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="#about"
                            
                            rel="noopener"
                            title="About"
                        >
                        <i class="sidebar-button-icon fa fa-question" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">About</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://github.com/xabikos"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="GitHub"
                        >
                        <i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="http://stackoverflow.com/users/2326486/xabikos"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="Stack Overflow"
                        >
                        <i class="sidebar-button-icon fab fa-stack-overflow" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Stack Overflow</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://twitter.com/xabikos"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="Twitter"
                        >
                        <i class="sidebar-button-icon fab fa-twitter" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Twitter</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://www.linkedin.com/in/charalamposkarypidis/"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="LinkedIn"
                        >
                        <i class="sidebar-button-icon fab fa-linkedin" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">LinkedIn</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="mailto:xaralaboskaripidis@gmail.com"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="Mail"
                        >
                        <i class="sidebar-button-icon fa fa-envelope" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Mail</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/atom.xml"
                            
                            rel="noopener"
                            title="RSS"
                        >
                        <i class="sidebar-button-icon fa fa-rss" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">RSS</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
            <div id="main" data-behavior="5"
                 class="
                        hasCoverMetaIn
                        ">
                
<article class="post">
    
    
        <div class="post-header main-content-wrap text-left">
    
        <h1 class="post-title">
            Create a multitenant application with Entity Framework Code First - Part 2
        </h1>
    
    
        <div class="post-meta">
    <time datetime="2014-11-18T20:15:00+02:00">
	
		    Nov 18, 2014
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/multitenant/">multitenant</a>, <a class="category-link" href="/categories/multitenant/application-design/">application design</a>, <a class="category-link" href="/categories/multitenant/application-design/software-as-a-service/">software as a service</a>


    
</div>

    
</div>

    
    <div class="post-content markdown">
        <div class="main-content-wrap">
            <h4 id="A-short-introduction"><a href="#A-short-introduction" class="headerlink" title="A short introduction"></a>A short introduction</h4><p>In continuation of <a href="/2014/11/17/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-1/">Part 1</a> about creating a multitenant application with Entity Framework Code First we are going to see how we can use Interceptors to apply filtering when querying the data in a transparent way for our application. It is highly recommended to read the <a href="/2014/11/17/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-1/">first part</a> as this post assumes you are already familiar with the problem.</p>
<span id="more"></span>
<p>The idea behind this implementation came up based on two very nice projects in Github which try to give a generic solution to the filtering problem. The first project is called <a target="_blank" rel="noopener" href="https://github.com/jbogard/EntityFramework.Filters/">EntityFramework.Filters</a> and it was the first one from <a target="_blank" rel="noopener" href="http://lostechies.com/jimmybogard/">Jimmy Bogard</a> which has a NuGet <a target="_blank" rel="noopener" href="https://www.nuget.org/packages/EntityFramework.Filters/">package</a> as well. The second very similar project which solved a couple of issues is <a target="_blank" rel="noopener" href="https://github.com/jcachat/EntityFramework.DynamicFilters/">EntityFramework.DynamicFilters</a> from <a target="_blank" rel="noopener" href="https://github.com/jcachat/">jcachat</a> which also comes with a NuGet <a target="_blank" rel="noopener" href="https://www.nuget.org/packages/EntityFramework.DynamicFilters/">package</a>. I have to highlight here that both of the projects give a wider solution to query filtering with Entity Framework and for our solution we are going to use just the general idea of filtering.</p>
<hr>
<h4 id="Entity-Framework-interceptors"><a href="#Entity-Framework-interceptors" class="headerlink" title="Entity Framework interceptors"></a>Entity Framework interceptors</h4><p><a target="_blank" rel="noopener" href="http://msdn.microsoft.com/en-us/data/dn469464.aspx#BuildingBlocks/">Interceptors</a> is a very powerful mechanism that Entity Framework added in version 6 and allows us to write custom code and then injecting in the framework’s execution pipeline. We can use interceptors to extend or modify the functionality of Entity Framework. A very common scenario in to use interceptors for database activity logging as you can see in <a target="_blank" rel="noopener" href="http://msdn.microsoft.com/en-us/data/dn469464.aspx#BuildingBlocks/">this example</a>. For our purposes we will use interceptors to modify first all the query commands to the database and in the next part the insert, update and delete commands.</p>
<hr>
<h4 id="The-command-tree-interceptor"><a href="#The-command-tree-interceptor" class="headerlink" title="The command tree interceptor"></a>The command tree interceptor</h4><p>The first step is to implement the IDbCommandTreeInterceptor and the TreeCreated method it declares, in order to take control of the query send to the database. The TenantCommandTreeInterceptor class is available below:</p>
<figure class="codeblock codeblock--tabbed"><figcaption><span>Query command Interceptor</span><ul class="tabs"><li class="tab active">cs</li></ul></figcaption><div class="tabs-content"><pre style="display: block;"><code>public class TenantCommandTreeInterceptor : IDbCommandTreeInterceptor {
    public void TreeCreated(DbCommandTreeInterceptionContext interceptionContext) {
        if (interceptionContext.OriginalResult.DataSpace == DataSpace.SSpace) {
            // Check that there is an authenticated user in this context
            var identity = Thread.CurrentPrincipal.Identity as ClaimsIdentity;
            if (identity == null){
                return;
            }
            var userIdclaim = identity.Claims.SingleOrDefault(c =&gt; c.Type == ClaimTypes.NameIdentifier);
            if (userIdclaim == null) {
                return;
            }
            // In case of query command change the query by adding a filtering based on tenantId
            var queryCommand = interceptionContext.Result as DbQueryCommandTree;
            if (queryCommand != null) {
                var newQuery = queryCommand.Query.Accept(new TenantQueryVisitor());
                interceptionContext.Result = new DbQueryCommandTree(
                    queryCommand.MetadataWorkspace,
                    queryCommand.DataSpace,
                    newQuery);
                return;
            }
        }
    }
}</code></pre></div></figure>

<p>I will try to explain the piece of code even though is not one of easiest concept in .net framework. A <a target="_blank" rel="noopener" href="http://msdn.microsoft.com/en-us/library/vstudio/ee789837(v=vs.100).aspx/">command tree</a> in most cases is the equivalent of an <a target="_blank" rel="noopener" href="http://msdn.microsoft.com/en-us/library/bb397951.aspx/">expression tree</a> that was created by a LINQ statement and Entity Framework can understand. In our case the query command tree is an object model representation of a query as is explained in the <a target="_blank" rel="noopener" href="http://msdn.microsoft.com/en-us/library/vstudio/ee789837(v=vs.100).aspx/">msdn</a> documentation. If we would like to make it more clear a query command tree is an object representation of a SQL select statement with all required parameters.</p>
<p>Initially we try to get the the identity of the user and verify that is logged in by getting the ClaimTypes.NameIdentifier. If the user is not logged we shouldn’t proceed with the interception as our requirement is to filter the data per user. The next few lines of code are relatively simple as we first examine if the command is a query command and if this is the case we continue with the interception. We create the new query which contains the filtering by applying the <a target="_blank" rel="noopener" href="http://en.wikipedia.org/wiki/Visitor_pattern/">Visitor design pattern</a> and the next step is to explicitly set the Result property of the interceptionContext by creating a new DbQueryCommandTree and return as the interception has done.</p>
<hr>
<h4 id="The-TenantQueryVisitor-class"><a href="#The-TenantQueryVisitor-class" class="headerlink" title="The TenantQueryVisitor class"></a>The TenantQueryVisitor class</h4><p>Now it’s time to see how the Query visitor class looks like.</p>
<figure class="codeblock codeblock--tabbed"><figcaption><span>Query expression visitor</span><ul class="tabs"><li class="tab active">cs</li></ul></figcaption><div class="tabs-content"><pre style="display: block;"><code>public class TenantQueryVisitor: DefaultExpressionVisitor {
    public override DbExpression Visit(DbScanExpression expression) {
        var column = TenantAwareAttribute.GetTenantColumnName(expression.Target.ElementType);

        if (!string.IsNullOrEmpty(column)) {
            // Get the current expression
            var dbExpression = base.Visit(expression);
            // Get the current expression binding
            var currentExpressionBinding = DbExpressionBuilder.Bind(dbExpression);
            // Create the variable reference in order to create the property
            var variableReference = DbExpressionBuilder.Variable(currentExpressionBinding.VariableType,
                currentExpressionBinding.VariableName);
            // Create the property based on the variable in order to apply the equality
            var tenantProperty = DbExpressionBuilder.Property(variableReference, column);
            // Create the parameter which is an object representation of a sql parameter.
            // We have to create a parameter and not perform a direct comparison with Equal function for example
            // as this logic is cached per query and called only once
            var tenantParameter = DbExpressionBuilder.Parameter(tenantProperty.Property.TypeUsage,
                TenantAwareAttribute.TenantIdFilterParameterName);
            // Apply the equality between property and parameter.
            var filterExpression = DbExpressionBuilder.Equal(tenantProperty, tenantParameter);
            // Apply the filtering to the initial query
            return DbExpressionBuilder.Filter(currentExpressionBinding, filterExpression);
        }

        return base.Visit(expression);
    }
}</code></pre></div></figure>

<p>The code here requires some knowledge of entity framework internals but I will try to explain it a bit more even though there are multiple comments in the code. What we are doing here is that we get the initial query and storing it in currentExpressionBinding variable. After doing this we create another expression which the SQL equivalent is “originalQuery AND TenantId &#x3D; @TenantIdParameter”. We could assign the value at this point and don’t use a SQL Parameter but this has a major problem as it’s highlighted in the comments. Internally Entity Framework caches the command tree by model as explained <a target="_blank" rel="noopener" href="https://entityframework.codeplex.com/SourceControl/latest#src/EntityFramework/Infrastructure/Interception/IDbCommandTreeInterceptor.cs">here</a> so if we apply the filtering at this point we will get back always the data for the first user accessed the application something that obvious wrong. This implementation detail adds the need of implementing another interceptor, that is in a lower level, and assign the SQL parameter value we created inside visitor class.</p>
<hr>
<h4 id="The-command-interceptor-class"><a href="#The-command-interceptor-class" class="headerlink" title="The command interceptor class"></a>The command interceptor class</h4><p>The command interceptor class is shown below:</p>
<figure class="codeblock codeblock--tabbed"><figcaption><span>Command Interceptor</span><ul class="tabs"><li class="tab active">cs</li></ul></figcaption><div class="tabs-content"><pre style="display: block;"><code>internal class TenantCommandInterceptor : IDbCommandInterceptor {
    public void NonQueryExecuting(DbCommand command, DbCommandInterceptionContext&lt;int&gt; interceptionContext){
        SetTenantParameterValue(command);
    }

    public void NonQueryExecuted(DbCommand command, DbCommandInterceptionContext&lt;int&gt; interceptionContext){}

    public void ReaderExecuting(DbCommand command, DbCommandInterceptionContext&lt;DbDataReader&gt; interceptionContext){
        SetTenantParameterValue(command);
    }

    public void ReaderExecuted(DbCommand command, DbCommandInterceptionContext&lt;DbDataReader&gt; interceptionContext){}

    public void ScalarExecuting(DbCommand command, DbCommandInterceptionContext&lt;object&gt; interceptionContext){
        SetTenantParameterValue(command);
    }

    public void ScalarExecuted(DbCommand command, DbCommandInterceptionContext&lt;object&gt; interceptionContext){}

    private static void SetTenantParameterValue(DbCommand command) {
        var identity = Thread.CurrentPrincipal.Identity as ClaimsIdentity;
        if ((command == null) || (command.Parameters.Count == 0) || identity == null) {
            return;
        }
        var userClaim = identity.Claims.SingleOrDefault(c =&gt; c.Type == ClaimTypes.NameIdentifier);
        if (userClaim != null) {
            var userId = userClaim.Value;
            // Enumerate all command parameters and assign the correct value in the one we added inside query visitor
            foreach (DbParameter param in command.Parameters) {
                if (param.ParameterName != TenantAwareAttribute.TenantIdFilterParameterName)
                    return;
                param.Value = userId;
            }
        }
    }
}</code></pre></div></figure>

<p>Here the logic is simpler as we just have to find the SQL Parameter if present and assign the correct value based on the user identity. The IDbCommandInterceptor contains six methods but in our use case we have to intercept only the ones executing before the command is sent to the database. I want to highlight here that is important how we access the required tenantId which in our case is the userId and we can find it from user’s identity. Now that async operations are very common this code could potentially executed by a thread that didn’t start the entire procedure so we have to make sure we can still access the required info.</p>
<hr>
<h4 id="Add-interceptors-in-Entity-Framework-pipeline"><a href="#Add-interceptors-in-Entity-Framework-pipeline" class="headerlink" title="Add interceptors in Entity Framework pipeline"></a>Add interceptors in Entity Framework pipeline</h4><p>The last step is to make Entity Framework aware of the interceptors we added before. To accomplish this we must use one of the latest addition in Framework the <a target="_blank" rel="noopener" href="http://msdn.microsoft.com/en-us/data/jj680699.aspx/">DbConfiguration</a> class. We have to derive from this class and add the two interceptors as the code snippet below shows:</p>
<figure class="codeblock codeblock--tabbed"><figcaption><span>Entity Framework Configuration</span><ul class="tabs"><li class="tab active">cs</li></ul></figcaption><div class="tabs-content"><pre style="display: block;"><code>public class EntityFrameworkConfiguration : DbConfiguration {
    public EntityFrameworkConfiguration() {
        AddInterceptor(new TenantCommandInterceptor());
        AddInterceptor(new TenantCommandTreeInterceptor());
    }
}</code></pre></div></figure>

<p>This class is very handy and powerful as we can do several configurations and is discovered automatically by Entity Framework. I want to note here that only one instance of a class deriving from DbConfiguration must exist per AppDomain.</p>
<hr>
<p>This was the second part of a series of three posts. You can find the first part <a href="/2014/11/17/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-1/">here</a>. I have created a <a target="_blank" rel="noopener" href="https://github.com/xabikos/EfMultitenant/">project in Github</a> that contains the full code in a relatively change model. In the next post I will describe how we can use interceptors to modify the insert, update and delete command.</p>
<h3 id="Part-1"><a href="#Part-1" class="headerlink" title="Part 1"></a><a href="/2014/11/17/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-1/">Part 1</a></h3><h3 id="Part-3"><a href="#Part-3" class="headerlink" title="Part 3"></a><a href="/2014/11/19/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-3/">Part 3</a></h3>
            


        </div>
    </div>
    <div id="post-footer" class="post-footer main-content-wrap">
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">TAGGED IN</span><br/>
                
    <a class="tag tag--primary tag--small t-none-link" href="/tags/code-first/" rel="tag">code first</a> <a class="tag tag--primary tag--small t-none-link" href="/tags/entity-framework/" rel="tag">entity framework</a> <a class="tag tag--primary tag--small t-none-link" href="/tags/interceptors/" rel="tag">interceptors</a> <a class="tag tag--primary tag--small t-none-link" href="/tags/multi-tenant/" rel="tag">multi-tenant</a>

            </div>
        
        
            <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2014/11/19/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-3/"
                    data-tooltip="Create a multitenant application with Entity Framework Code First - Part 3"
                    aria-label="PREVIOUS: Create a multitenant application with Entity Framework Code First - Part 3"
                >
                    
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2014/11/17/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-1/"
                    data-tooltip="Create a multitenant application with Entity Framework Code First - Part 1"
                    aria-label="NEXT: Create a multitenant application with Entity Framework Code First - Part 1"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="Share this post"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://xabikos.com/2014/11/18/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-2/"
                    title="Share on Facebook"
                    aria-label="Share on Facebook"
                >
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=https://xabikos.com/2014/11/18/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-2/"
                    title="Share on Twitter"
                    aria-label="Share on Twitter"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
                <li class="post-action">
                    <a
                        class="post-action-btn btn btn--default"
                        href="#disqus_thread"
                        aria-label="Leave a comment"
                    >
                        <i class="fa fa-comment"></i>
                    </a>
                </li>
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="Back to top">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


        
        
            
                <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
            
        
    </div>
</article>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2024 Babis Karypidis. All Rights Reserved.
    </span>
</footer>

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="5">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2014/11/19/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-3/"
                    data-tooltip="Create a multitenant application with Entity Framework Code First - Part 3"
                    aria-label="PREVIOUS: Create a multitenant application with Entity Framework Code First - Part 3"
                >
                    
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2014/11/17/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-1/"
                    data-tooltip="Create a multitenant application with Entity Framework Code First - Part 1"
                    aria-label="NEXT: Create a multitenant application with Entity Framework Code First - Part 1"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="Share this post"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://xabikos.com/2014/11/18/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-2/"
                    title="Share on Facebook"
                    aria-label="Share on Facebook"
                >
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=https://xabikos.com/2014/11/18/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-2/"
                    title="Share on Twitter"
                    aria-label="Share on Twitter"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
                <li class="post-action">
                    <a
                        class="post-action-btn btn btn--default"
                        href="#disqus_thread"
                        aria-label="Leave a comment"
                    >
                        <i class="fa fa-comment"></i>
                    </a>
                </li>
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="Back to top">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


                </div>
                
    <div id="share-options-bar" class="share-options-bar" data-behavior="5">
        <i id="btn-close-shareoptions" class="fa fa-times"></i>
        <ul class="share-options">
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://www.facebook.com/sharer/sharer.php?u=https://xabikos.com/2014/11/18/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-2/"
                        aria-label="Share on Facebook"
                    >
                        <i class="fab fa-facebook" aria-hidden="true"></i><span>Share on Facebook</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://twitter.com/intent/tweet?text=https://xabikos.com/2014/11/18/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-2/"
                        aria-label="Share on Twitter"
                    >
                        <i class="fab fa-twitter" aria-hidden="true"></i><span>Share on Twitter</span>
                    </a>
                </li>
            
        </ul>
    </div>


            
        </div>
        


    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <img id="about-card-picture" src="https://www.gravatar.com/avatar/7c9ee05396641133c8d505197fc17cc5?s=110" alt="Author&#39;s picture"/>
        
            <h4 id="about-card-name">Babis Karypidis</h4>
        
            <div id="about-card-bio"><p>Hi, I am Babis Karypidis, a Greek software engineer who tries to fit other activities, except development, in his life.</p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>Freelance Software Engineer focusing on .NET, Azure and React.js</p>

            </div>
        
        
            <div id="about-card-location">
                <i class="fa fa-map-marker-alt"></i>
                <br/>
                Thessaloniki, Greece
            </div>
        
    </div>
</div>

        
        
<div id="cover" style="background-image:url('/assets/images/cover.jpg');"></div>
        <!--SCRIPTS-->

<script src="/assets/js/script-yyz2rnzpilmc2udfgqml9ilwziu3ydccm9bogkls7cijrn6iwnrwirlgdjmo.min.js"></script>

<!--SCRIPTS END-->


    
        <script>
          var disqus_config = function() {
            this.page.url = 'https://xabikos.com/2014/11/18/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-2/';
              
            this.page.identifier = '2014/11/18/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-2/';
              
          };
          (function() {
            var d = document, s = d.createElement('script');
            var disqus_shortname = 'xabikos';
            s.src = '//' + disqus_shortname + '.disqus.com/embed.js';

            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
          })();
        </script>
    




    </body>
</html>
