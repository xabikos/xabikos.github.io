
<!DOCTYPE html>
<html lang="en">
    
<head>
    <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" >
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Web development with asp.net and React.js">
    <title>Create a multitenant application with Entity Framework Code First - Part 2 - Web development with asp.net and React.js</title>
    <meta name="author" content="Babis Karypidis">
    
        <meta name="keywords" content="entity framework,multitenant,code first">
    
    
    
        <link rel="alternate" type="application/atom+xml" title="RSS" href="/atom.xml">
    
    <meta name="description" content="A short introductionIn continuation of Part 1 about creating a multitenant application with Entity Framework Code First we are going to see how we can use Interceptors to apply filtering when querying">
<meta property="og:type" content="blog">
<meta property="og:title" content="Create a multitenant application with Entity Framework Code First - Part 2">
<meta property="og:url" content="http://xabikostest.github.io/2014/11/18/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-2/index.html">
<meta property="og:site_name" content="Web development with asp.net and React.js">
<meta property="og:description" content="A short introductionIn continuation of Part 1 about creating a multitenant application with Entity Framework Code First we are going to see how we can use Interceptors to apply filtering when querying">
<meta property="og:updated_time" content="2016-04-27T16:51:43.213Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Create a multitenant application with Entity Framework Code First - Part 2">
<meta name="twitter:description" content="A short introductionIn continuation of Part 1 about creating a multitenant application with Entity Framework Code First we are going to see how we can use Interceptors to apply filtering when querying">
<meta name="twitter:creator" content="@xabikos">
    
    
        
    
    
        <meta property="og:image" content="http://www.gravatar.com/avatar/7c9ee05396641133c8d505197fc17cc5?s=640"/>
    
    
    
    
    <!--STYLES-->
    <link rel="stylesheet" href="/assets/css/style-quwccsthbllipo6252snb2tfkddvrsp1eczkytpz3vmxpsb6nwodixemlkux.min.css" type="text/css">
    <!--STYLES END-->
    
    <script type="text/javascript">
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-56484404-1']);
        _gaq.push(['_trackPageview']);
        (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
    </script>

    
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    
        
    

<header id="header" data-behavior="4">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <h1 class="header-title">
        <a class="header-title-link" href="/ ">Web development with asp.net and React.js</a>
    </h1>
    
        
            <a  class="header-right-picture "
                href="/#about">
        
        
            <img class="header-picture" src="http://www.gravatar.com/avatar/7c9ee05396641133c8d505197fc17cc5?s=90"/>
        
        </a>
    
</header>

            <!-- Define author's picture -->


    

<nav id="sidebar" data-behavior="4">
    
        <div class="sidebar-profile">
            <a href="/#about">
                    <img class="sidebar-profile-picture" src="http://www.gravatar.com/avatar/7c9ee05396641133c8d505197fc17cc5?s=110"/>
            </a>
            <span class="sidebar-profile-name">Babis Karypidis</span>
        </div>
    
    
        <ul class="sidebar-buttons">
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/ "
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-home"></i>
                    <span class="sidebar-button-desc">Home</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/all-categories"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
                    <span class="sidebar-button-desc">Categories</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/all-tags"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
                    <span class="sidebar-button-desc">Tags</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/#about"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-question"></i>
                    <span class="sidebar-button-desc">About</span>
                </a>
        </li>
        
    </ul>
    
        <ul class="sidebar-buttons">
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link " href="https://github.com/xabikos" target="_blank">
                
                    <i class="sidebar-button-icon fa fa-lg fa-github"></i>
                    <span class="sidebar-button-desc">GitHub</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link " href="https://twitter.com/xabikos" target="_blank">
                
                    <i class="sidebar-button-icon fa fa-lg fa-twitter"></i>
                    <span class="sidebar-button-desc">Twitter</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link " href="https://www.linkedin.com/in/charalamposkarypidis/" target="_blank">
                
                    <i class="sidebar-button-icon fa fa-lg fa-linkedin"></i>
                    <span class="sidebar-button-desc">LinkedIn</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link " href="mailto:xaralaboskaripidis@gmail.com" target="_blank">
                
                    <i class="sidebar-button-icon fa fa-lg fa-envelope-o"></i>
                    <span class="sidebar-button-desc">Mail</span>
                </a>
        </li>
        
    </ul>
    
        <ul class="sidebar-buttons">
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/atom.xml"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-rss"></i>
                    <span class="sidebar-button-desc">RSS</span>
                </a>
        </li>
        
    </ul>
    
</nav>

            
            <div id="main" data-behavior="4"
                 class="
                        hasCoverMetaIn
                        ">
                
<article class="post" itemscope itemType="http://schema.org/BlogPosting">
    
    
        <div class="post-header main-content-wrap text-left">
    
        <h1 class="post-title" itemprop="headline">
            Create a multitenant application with Entity Framework Code First - Part 2
        </h1>
    
    <div class="post-meta">
    <time itemprop="datePublished" content="Tue Nov 18 2014 20:15:00 GMT+0100">
	
		    Nov 18, 2014
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/multitenant/">multitenant</a>, <a class="category-link" href="/categories/multitenant/application-design/">application design</a>, <a class="category-link" href="/categories/multitenant/application-design/software-as-a-service/">software as a service</a>


    
</div>
</div>
    
    <div class="post-content markdown" itemprop="articleBody">
        <div class="main-content-wrap">
            <h4 id="A-short-introduction"><a href="#A-short-introduction" class="headerlink" title="A short introduction"></a>A short introduction</h4><p>In continuation of <a href="/2014/11/17/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-1/">Part 1</a> about creating a multitenant application with Entity Framework Code First we are going to see how we can use Interceptors to apply filtering when querying the data in a transparent way for our application. It is highly recommended to read the <a href="/2014/11/17/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-1/">first part</a> as this post assumes you are already familiar with the problem.<br><a id="more"></a><br>The idea behind this implementation came up based on two very nice projects in Github which try to give a generic solution to the filtering problem. The first project is called <a href="https://github.com/jbogard/EntityFramework.Filters/" target="_blank" rel="external">EntityFramework.Filters</a> and it was the first one from <a href="http://lostechies.com/jimmybogard/" target="_blank" rel="external">Jimmy Bogard</a> which has a NuGet <a href="https://www.nuget.org/packages/EntityFramework.Filters/" target="_blank" rel="external">package</a> as well. The second very similar project which solved a couple of issues is <a href="https://github.com/jcachat/EntityFramework.DynamicFilters/" target="_blank" rel="external">EntityFramework.DynamicFilters</a> from <a href="https://github.com/jcachat/" target="_blank" rel="external">jcachat</a> which also comes with a NuGet <a href="https://www.nuget.org/packages/EntityFramework.DynamicFilters/" target="_blank" rel="external">package</a>. I have to highlight here that both of the projects give a wider solution to query filtering with Entity Framework and for our solution we are going to use just the general idea of filtering.</p>
<hr>
<h4 id="Entity-Framework-interceptors"><a href="#Entity-Framework-interceptors" class="headerlink" title="Entity Framework interceptors"></a>Entity Framework interceptors</h4><p><a href="http://msdn.microsoft.com/en-us/data/dn469464.aspx#BuildingBlocks/" target="_blank" rel="external">Interceptors</a> is a very powerful mechanism that Entity Framework added in version 6 and allows us to write custom code and then injecting in the framework’s execution pipeline. We can use interceptors to extend or modify the functionality of Entity Framework. A very common scenario in to use interceptors for database activity logging as you can see in <a href="http://msdn.microsoft.com/en-us/data/dn469464.aspx#BuildingBlocks/" target="_blank" rel="external">this example</a>. For our purposes we will use interceptors to modify first all the query commands to the database and in the next part the insert, update and delete commands.</p>
<hr>
<h4 id="The-command-tree-interceptor"><a href="#The-command-tree-interceptor" class="headerlink" title="The command tree interceptor"></a>The command tree interceptor</h4><p>The first step is to implement the IDbCommandTreeInterceptor and the TreeCreated method it declares, in order to take control of the query send to the database. The TenantCommandTreeInterceptor class is available below:<br><figure class="codeblock codeblock--tabbed"><figcaption><span>Query command Interceptor</span><ul class="tabs"><li class="tab active">cs</li></ul></figcaption><div class="tabs-content"><figure class="highlight cs" style="display: block;"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TenantCommandTreeInterceptor</span> : <span class="title">IDbCommandTreeInterceptor</span> {</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">TreeCreated</span>(<span class="params">DbCommandTreeInterceptionContext interceptionContext</span>) </span>{</span><br><span class="line">        <span class="keyword">if</span> (interceptionContext.OriginalResult.DataSpace == DataSpace.SSpace) {</span><br><span class="line">            <span class="comment">// Check that there is an authenticated user in this context</span></span><br><span class="line">            <span class="keyword">var</span> identity = Thread.CurrentPrincipal.Identity <span class="keyword">as</span> ClaimsIdentity;</span><br><span class="line">            <span class="keyword">if</span> (identity == <span class="keyword">null</span>){</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">var</span> userIdclaim = identity.Claims.SingleOrDefault(c =&gt; c.Type == ClaimTypes.NameIdentifier);</span><br><span class="line">            <span class="keyword">if</span> (userIdclaim == <span class="keyword">null</span>) {</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            }</span><br><span class="line">            <span class="comment">// In case of query command change the query by adding a filtering based on tenantId</span></span><br><span class="line">            <span class="keyword">var</span> queryCommand = interceptionContext.Result <span class="keyword">as</span> DbQueryCommandTree;</span><br><span class="line">            <span class="keyword">if</span> (queryCommand != <span class="keyword">null</span>) {</span><br><span class="line">                <span class="keyword">var</span> newQuery = queryCommand.Query.Accept(<span class="keyword">new</span> TenantQueryVisitor());</span><br><span class="line">                interceptionContext.Result = <span class="keyword">new</span> DbQueryCommandTree(</span><br><span class="line">                    queryCommand.MetadataWorkspace,</span><br><span class="line">                    queryCommand.DataSpace,</span><br><span class="line">                    newQuery);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div></figure></p>
<p>I will try to explain the piece of code even though is not one of easiest concept in .net framework. A <a href="http://msdn.microsoft.com/en-us/library/vstudio/ee789837(v=vs.100).aspx/" target="_blank" rel="external">command tree</a> in most cases is the equivalent of an <a href="http://msdn.microsoft.com/en-us/library/bb397951.aspx/" target="_blank" rel="external">expression tree</a> that was created by a LINQ statement and Entity Framework can understand. In our case the query command tree is an object model representation of a query as is explained in the <a href="http://msdn.microsoft.com/en-us/library/vstudio/ee789837(v=vs.100).aspx/" target="_blank" rel="external">msdn</a> documentation. If we would like to make it more clear a query command tree is an object representation of a SQL select statement with all required parameters.</p>
<p>Initially we try to get the the identity of the user and verify that is logged in by getting the ClaimTypes.NameIdentifier. If the user is not logged we shouldn’t proceed with the interception as our requirement is to filter the data per user. The next few lines of code are relatively simple as we first examine if the command is a query command and if this is the case we continue with the interception. We create the new query which contains the filtering by applying the <a href="http://en.wikipedia.org/wiki/Visitor_pattern/" target="_blank" rel="external">Visitor design pattern</a> and the next step is to explicitly set the Result property of the interceptionContext by creating a new DbQueryCommandTree and return as the interception has done.</p>
<hr>
<h4 id="The-TenantQueryVisitor-class"><a href="#The-TenantQueryVisitor-class" class="headerlink" title="The TenantQueryVisitor class"></a>The TenantQueryVisitor class</h4><p>Now it’s time to see how the Query visitor class looks like.</p>
<figure class="codeblock codeblock--tabbed"><figcaption><span>Query expression visitor</span><ul class="tabs"><li class="tab active">cs</li></ul></figcaption><div class="tabs-content"><figure class="highlight cs" style="display: block;"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TenantQueryVisitor</span>: <span class="title">DefaultExpressionVisitor</span> {</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> DbExpression <span class="title">Visit</span>(<span class="params">DbScanExpression expression</span>) </span>{</span><br><span class="line">        <span class="keyword">var</span> column = TenantAwareAttribute.GetTenantColumnName(expression.Target.ElementType);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">string</span>.IsNullOrEmpty(column)) {</span><br><span class="line">            <span class="comment">// Get the current expression</span></span><br><span class="line">            <span class="keyword">var</span> dbExpression = <span class="keyword">base</span>.Visit(expression);</span><br><span class="line">            <span class="comment">// Get the current expression binding</span></span><br><span class="line">            <span class="keyword">var</span> currentExpressionBinding = DbExpressionBuilder.Bind(dbExpression);</span><br><span class="line">            <span class="comment">// Create the variable reference in order to create the property</span></span><br><span class="line">            <span class="keyword">var</span> variableReference = DbExpressionBuilder.Variable(currentExpressionBinding.VariableType,</span><br><span class="line">                currentExpressionBinding.VariableName);</span><br><span class="line">            <span class="comment">// Create the property based on the variable in order to apply the equality</span></span><br><span class="line">            <span class="keyword">var</span> tenantProperty = DbExpressionBuilder.Property(variableReference, column);</span><br><span class="line">            <span class="comment">// Create the parameter which is an object representation of a sql parameter.</span></span><br><span class="line">            <span class="comment">// We have to create a parameter and not perform a direct comparison with Equal function for example</span></span><br><span class="line">            <span class="comment">// as this logic is cached per query and called only once</span></span><br><span class="line">            <span class="keyword">var</span> tenantParameter = DbExpressionBuilder.Parameter(tenantProperty.Property.TypeUsage,</span><br><span class="line">                TenantAwareAttribute.TenantIdFilterParameterName);</span><br><span class="line">            <span class="comment">// Apply the equality between property and parameter.</span></span><br><span class="line">            <span class="keyword">var</span> filterExpression = DbExpressionBuilder.Equal(tenantProperty, tenantParameter);</span><br><span class="line">            <span class="comment">// Apply the filtering to the initial query</span></span><br><span class="line">            <span class="keyword">return</span> DbExpressionBuilder.Filter(currentExpressionBinding, filterExpression);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">base</span>.Visit(expression);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div></figure>
<p>The code here requires some knowledge of entity framework internals but I will try to explain it a bit more even though there are multiple comments in the code. What we are doing here is that we get the initial query and storing it in currentExpressionBinding variable. After doing this we create another expression which the SQL equivalent is “originalQuery AND TenantId = @TenantIdParameter”. We could assign the value at this point and don’t use a SQL Parameter but this has a major problem as it’s highlighted in the comments. Internally Entity Framework caches the command tree by model as explained <a href="https://entityframework.codeplex.com/SourceControl/latest#src/EntityFramework/Infrastructure/Interception/IDbCommandTreeInterceptor.cs" target="_blank" rel="external">here</a> so if we apply the filtering at this point we will get back always the data for the first user accessed the application something that obvious wrong. This implementation detail adds the need of implementing another interceptor, that is in a lower level, and assign the SQL parameter value we created inside visitor class.</p>
<hr>
<h4 id="The-command-interceptor-class"><a href="#The-command-interceptor-class" class="headerlink" title="The command interceptor class"></a>The command interceptor class</h4><p>The command interceptor class is shown below:<br><figure class="codeblock codeblock--tabbed"><figcaption><span>Command Interceptor</span><ul class="tabs"><li class="tab active">cs</li></ul></figcaption><div class="tabs-content"><figure class="highlight cs" style="display: block;"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">TenantCommandInterceptor</span> : <span class="title">IDbCommandInterceptor</span> {</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">NonQueryExecuting</span>(<span class="params">DbCommand command, DbCommandInterceptionContext&lt;<span class="keyword">int</span>&gt; interceptionContext</span>)</span>{</span><br><span class="line">        SetTenantParameterValue(command);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">NonQueryExecuted</span>(<span class="params">DbCommand command, DbCommandInterceptionContext&lt;<span class="keyword">int</span>&gt; interceptionContext</span>)</span>{}</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ReaderExecuting</span>(<span class="params">DbCommand command, DbCommandInterceptionContext&lt;DbDataReader&gt; interceptionContext</span>)</span>{</span><br><span class="line">        SetTenantParameterValue(command);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ReaderExecuted</span>(<span class="params">DbCommand command, DbCommandInterceptionContext&lt;DbDataReader&gt; interceptionContext</span>)</span>{}</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ScalarExecuting</span>(<span class="params">DbCommand command, DbCommandInterceptionContext&lt;<span class="keyword">object</span>&gt; interceptionContext</span>)</span>{</span><br><span class="line">        SetTenantParameterValue(command);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ScalarExecuted</span>(<span class="params">DbCommand command, DbCommandInterceptionContext&lt;<span class="keyword">object</span>&gt; interceptionContext</span>)</span>{}</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">SetTenantParameterValue</span>(<span class="params">DbCommand command</span>) </span>{</span><br><span class="line">        <span class="keyword">var</span> identity = Thread.CurrentPrincipal.Identity <span class="keyword">as</span> ClaimsIdentity;</span><br><span class="line">        <span class="keyword">if</span> ((command == <span class="keyword">null</span>) || (command.Parameters.Count == <span class="number">0</span>) || identity == <span class="keyword">null</span>) {</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">var</span> userClaim = identity.Claims.SingleOrDefault(c =&gt; c.Type == ClaimTypes.NameIdentifier);</span><br><span class="line">        <span class="keyword">if</span> (userClaim != <span class="keyword">null</span>) {</span><br><span class="line">            <span class="keyword">var</span> userId = userClaim.Value;</span><br><span class="line">            <span class="comment">// Enumerate all command parameters and assign the correct value in the one we added inside query visitor</span></span><br><span class="line">            <span class="keyword">foreach</span> (DbParameter param <span class="keyword">in</span> command.Parameters) {</span><br><span class="line">                <span class="keyword">if</span> (param.ParameterName != TenantAwareAttribute.TenantIdFilterParameterName)</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                param.Value = userId;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div></figure></p>
<p>Here the logic is simpler as we just have to find the SQL Parameter if present and assign the correct value based on the user identity. The IDbCommandInterceptor contains six methods but in our use case we have to intercept only the ones executing before the command is sent to the database. I want to highlight here that is important how we access the required tenantId which in our case is the userId and we can find it from user’s identity. Now that async operations are very common this code could potentially executed by a thread that didn’t start the entire procedure so we have to make sure we can still access the required info.</p>
<hr>
<h4 id="Add-interceptors-in-Entity-Framework-pipeline"><a href="#Add-interceptors-in-Entity-Framework-pipeline" class="headerlink" title="Add interceptors in Entity Framework pipeline"></a>Add interceptors in Entity Framework pipeline</h4><p>The last step is to make Entity Framework aware of the interceptors we added before. To accomplish this we must use one of the latest addition in Framework the <a href="http://msdn.microsoft.com/en-us/data/jj680699.aspx/" target="_blank" rel="external">DbConfiguration</a> class. We have to derive from this class and add the two interceptors as the code snippet below shows:<br><figure class="codeblock codeblock--tabbed"><figcaption><span>Entity Framework Configuration</span><ul class="tabs"><li class="tab active">cs</li></ul></figcaption><div class="tabs-content"><figure class="highlight cs" style="display: block;"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EntityFrameworkConfiguration</span> : <span class="title">DbConfiguration</span> {</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">EntityFrameworkConfiguration</span>(<span class="params"></span>) </span>{</span><br><span class="line">        AddInterceptor(<span class="keyword">new</span> TenantCommandInterceptor());</span><br><span class="line">        AddInterceptor(<span class="keyword">new</span> TenantCommandTreeInterceptor());</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div></figure></p>
<p>This class is very handy and powerful as we can do several configurations and is discovered automatically by Entity Framework. I want to note here that only one instance of a class deriving from DbConfiguration must exist per AppDomain.</p>
<hr>
<p>This was the second part of a series of three posts. You can find the first part <a href="/2014/11/17/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-1/">here</a>. I have created a <a href="https://github.com/xabikos/EfMultitenant/" target="_blank" rel="external">project in Github</a> that contains the full code in a relatively change model. In the next post I will describe how we can use interceptors to modify the insert, update and delete command.</p>
<h3 id="Part-1"><a href="#Part-1" class="headerlink" title="Part 1"></a><a href="/2014/11/17/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-1/">Part 1</a></h3><h3 id="Part-3"><a href="#Part-3" class="headerlink" title="Part 3"></a><a href="/2014/11/19/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-3/">Part 3</a></h3>
            
        </div>
    </div>
    <div id="post-footer" class="post-footer main-content-wrap">
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">TAGGED IN</span><br/>
                
    <a class="tag tag--primary tag--small t-link" href="/tags/code-first/">code first</a> <a class="tag tag--primary tag--small t-link" href="/tags/entity-framework/">entity framework</a> <a class="tag tag--primary tag--small t-link" href="/tags/interceptors/">interceptors</a> <a class="tag tag--primary tag--small t-link" href="/tags/multi-tenant/">multi-tenant</a>

            </div>
        
        <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2014/11/19/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-3/"  data-tooltip="Create a multitenant application with Entity Framework Code First - Part 3">
                
                    <i class="fa fa-angle-left"></i>
                    <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                </a>
            </li>
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2014/11/17/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-1/" data-tooltip="Create a multitenant application with Entity Framework Code First - Part 1">
                
                    <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                    <i class="fa fa-angle-right"></i>
                </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a class="post-action-btn btn btn--default btn-open-shareoptions"  href="#btn-open-shareoptions">
                <i class="fa fa-share-alt"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=http://xabikostest.github.io/2014/11/18/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-2/">
                <i class="fa fa-google-plus"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://xabikostest.github.io/2014/11/18/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-2/">
                <i class="fa fa-facebook-official"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=http://xabikostest.github.io/2014/11/18/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-2/">
                <i class="fa fa-twitter"></i>
            </a>
        </li>
        
            <li class="post-action">
                <a class="post-action-btn btn btn--default" href="#disqus_thread">
                    <i class="fa fa-comment-o"></i>
                </a>
            </li>
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#">
            
                <i class="fa fa-list"></i>
            </a>
        </li>
    </ul>
</div>


        
            
                <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
            
        
    </div>
</article>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2016 Babis Karypidis. All Rights Reserved.
    </span>
</footer>

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="4">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2014/11/19/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-3/"  data-tooltip="Create a multitenant application with Entity Framework Code First - Part 3">
                
                    <i class="fa fa-angle-left"></i>
                    <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                </a>
            </li>
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2014/11/17/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-1/" data-tooltip="Create a multitenant application with Entity Framework Code First - Part 1">
                
                    <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                    <i class="fa fa-angle-right"></i>
                </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a class="post-action-btn btn btn--default btn-open-shareoptions"  href="#btn-open-shareoptions">
                <i class="fa fa-share-alt"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=http://xabikostest.github.io/2014/11/18/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-2/">
                <i class="fa fa-google-plus"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://xabikostest.github.io/2014/11/18/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-2/">
                <i class="fa fa-facebook-official"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=http://xabikostest.github.io/2014/11/18/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-2/">
                <i class="fa fa-twitter"></i>
            </a>
        </li>
        
            <li class="post-action">
                <a class="post-action-btn btn btn--default" href="#disqus_thread">
                    <i class="fa fa-comment-o"></i>
                </a>
            </li>
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#">
            
                <i class="fa fa-list"></i>
            </a>
        </li>
    </ul>
</div>


                </div>
                <div id="share-options-bar" class="share-options-bar" data-behavior="4">
    <ul class="share-options">
        <li class="share-option">
            <a class="share-option-btn" target="new" href="https://plus.google.com/share?url=http://xabikostest.github.io/2014/11/18/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-2/">
                <i class="fa fa-google-plus"></i><span class="">Share on Google Plus</span>
            </a>
        </li>
        <li class="share-option">
            <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://xabikostest.github.io/2014/11/18/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-2/">
                <i class="fa fa-facebook-official"></i><span>Share on Facebook</span>
            </a>
        </li>
        <li class="share-option">
            <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=http://xabikostest.github.io/2014/11/18/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-2/">
                <i class="fa fa-twitter"></i><span>Share on Twitter</span>
            </a>
        </li>
    </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>
            
        </div>
        


    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-remove"></i>
        </div>
        
            <img id="about-card-picture" src="http://www.gravatar.com/avatar/7c9ee05396641133c8d505197fc17cc5?s=110"/>
        
            <h4 id="about-card-name">Babis Karypidis</h4>
        
            <h5 id="about-card-bio"><p>Hi, I am Babis Karypidis, a Greek software engineer who tries to fit other activities, except development, in his life.</p>
</h5>
        
        
            <h5 id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>Freelance Software Engineer focusing on .NET, Azure and React.js</p>

            </h5>
        
        
            <h5 id="about-card-location">
                <i class="fa fa-map-marker"></i>
                <br/>
                Brussels, Belgium
            </h5>
        
    </div>
</div>

        
<div id="cover" style="background-image:url('https://globalazurereport.blob.core.windows.net/personalblog/web_development_top.jpg');"></div>
    </body>
    <!--SCRIPTS-->
<script src="/assets/js/scrip-rjanlllosg30d03qrddpwrs6wqf4k3v0bbo68hiifuvthyhqfefx2htcagu0.min.js" type="text/javascript"></script>
<!--SCRIPTS END-->

    
        <script>
             var disqus_config = function () {
                 this.page.url = 'http://xabikostest.github.io/2014/11/18/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-2/';
                 
                    this.page.identifier = '2014/11/18/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-2/';
                                  
             };
            (function() {
                var d = document, s = d.createElement('script');
                var disqus_shortname = 'xabikos';
                s.src = '//' + disqus_shortname + '.disqus.com/embed.js';

                s.setAttribute('data-timestamp', +new Date());
                (d.head || d.body).appendChild(s);
            })();
        </script>
    



</html>
