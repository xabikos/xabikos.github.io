
<!DOCTYPE html>
<html lang="en">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Web development with asp.net and React.js">
    <title>Create a multitenant application with Entity Framework Code First - Part 1 - Web development with asp.net and React.js</title>
    <meta name="author" content="Babis Karypidis">
    
        <meta name="keywords" content="entity framework,multitenant,code first">
    
    
    
        
            <link rel="alternate" type="application/atom+xml" title="RSS" href="/atom.xml">
        
    
    <script type="application/ld+json">{"@context":"http://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Babis Karypidis","sameAs":["https://github.com/xabikos","http://stackoverflow.com/users/2326486/xabikos","https://twitter.com/xabikos","https://www.linkedin.com/in/charalamposkarypidis/","mailto:xaralaboskaripidis@gmail.com"],"image":"https://www.gravatar.com/avatar/7c9ee05396641133c8d505197fc17cc5"},"articleBody":"A highly increasing request we have to serve as developers, especially after Software as a Service revolution, is to provide software that is able to handle individual users in one application by separate each user’s data. This feature is called Multitenancy and there are several ways to achieve it. In this series of posts I will try to demonstrate how we can achieve the data isolation by using some advance features of Entity Framework.\n\n\nThe really simple modelThe first part includes the description of the model used across the application. Lets assume we want to manage some Messages for our application and each logged in user should be able to access and modify only his personal messages. The Message is a classic POCO class that doesn’t have any Entity Framework specific code as you can see in the snippet below.\nMessage POCOcspublic class Message {\n    public long Id { get; set; }\n    public string TenantId { get; set; }\n    public virtual ApplicationUser User { get; set; }\n    [Required]\n    public string Description { get; set; }\n}\n\nWe follow mainly the convention over configuration approach Entity Framework provides and the only explicit configuration we have to apply in our Message class is to declare TenantId as foreign key for User property by adding the code that follows in the DbContext class we are going to use for data access.\nEntity configurationcsprotected override void OnModelCreating(DbModelBuilder modelBuilder) {\n    base.OnModelCreating(modelBuilder);\n\n    modelBuilder.Entity&lt;Message&gt;()\n        .HasRequired(m =&gt; m.User)\n        .WithMany()\n        .HasForeignKey(m =&gt; m.TenantId)\n        .WillCascadeOnDelete(true);\n}\n\n\nThe “manual” approachI will first implement an MVC Controller that includes the logic of filtering based on TenantId and assign the correct TenantId when creating a new message. The code we have to write is more or less like the snippet below:\nControllercs[Authorize]\npublic class MessagesController : Controller {\n    private ApplicationDbContext db = new ApplicationDbContext();\n\n    private string UserId { get { return User.Identity.IsAuthenticated ? User.Identity.GetUserId() : string.Empty; }}\n\n    public ActionResult Index() {\n        // Tenant specific query logic\n        var messages = db.Messages.Include(m =&gt; m.User).Where(m =&gt; m.TenantId == UserId);\n        return View(messages.ToList());\n    }\n\n    public ActionResult Details(long? id) {\n        // Tenant specific query logic\n        Message message = db.Messages.SingleOrDefault(m =&gt; m.Id == id &amp;&amp; m.TenantId == UserId);\n        if (message == null) {\n            return HttpNotFound();\n        }\n        return View(message);\n    }\n\n    public ActionResult Create([Bind(Include = \"Id,Description\")] Message message) {\n        if (ModelState.IsValid) {\n            // Assign tenant Id explicitly\n            message.TenantId = UserId;\n            db.Messages.Add(message);\n            db.SaveChanges();\n            return RedirectToAction(\"Index\");\n        }\n        return View(message);\n    }\n\n    public ActionResult Edit(long? id) {\n        // Tenant specific query logic\n        Message message = db.Messages.SingleOrDefault(m =&gt; m.Id == id &amp;&amp; m.TenantId == UserId);\n        if (message == null) {\n            return HttpNotFound();\n        }\n        return View(message);\n    }\n\n    public ActionResult Edit([Bind(Include = \"Id,Description\")] Message message) {\n        if (ModelState.IsValid) {\n            // Assign tenant Id explicitly\n            message.TenantId = UserId;\n            db.Entry(message).State = EntityState.Modified;\n            db.SaveChanges();\n            return RedirectToAction(\"Index\");\n        }\n        return View(message);\n    }\n}\n\nI didn’t include all required logic and also removed the delete functionality but the problem of always remember to filter the correct data is obvious. On top of this we must assign the TenantId property explicitly as the user should not be able to do something like this. This approach is of course a valid solution but requires a lot of repetition of the same logic throughout our application something that is always error prone. On top of this the entire application has knowledge of the TenantId concept. We could solve this problem by creating a base class, something like base Repository or similar approach, and hide this detail there. This would definitely improve the design but still when the base class is not enough we have to remember to apply the filtering.\n\nEntity Framework InterceptorsEntity Framework Interceptors is a very powerful feature added in version 6 of the framework and we can use them in order to hide the filtering and assign the correct TenantId in only one place. To be able to do that we must first write some infrastructure code.\n\nTenantAwareAttribute and custom conventionThe first step is to create an ordinary attribute class with which we can annotate our classes in order to get the Tenant functionality automatically. The code for the attribute class is shown below:\nCustom Attributecs[AttributeUsage(AttributeTargets.Class, AllowMultiple = false)]\npublic class TenantAwareAttribute : Attribute {\n    public const string TenantAnnotation = \"TenantAnnotation\";\n    public const string TenantIdFilterParameterName = \"TenantIdParameter\";\n\n    public string ColumnName { get; private set; }\n\n    public TenantAwareAttribute(string columnName) {\n        ColumnName = columnName;\n    }\n\n    public static string GetTenantColumnName(EdmType type) {\n        MetadataProperty annotation = type.MetadataProperties.SingleOrDefault(\n            p =&gt; p.Name.EndsWith(string.Format(\"customannotation:{0}\", TenantAnnotation)));\n\n        return annotation == null ? null : (string)annotation.Value;\n    }\n}\n\nWhen using this attribute we have to declare which property of the class is the one responsible for TenantId. Moreover exposes a static helper method to get the the tenant column name based on the EdmType.\nThe next step is to use this attribute by adding a custom Entity Framework convention to the DbContext class we are going to use for data access in our application. To do this we have to add the code snippet below on the DbContext class.\nAdd attribute to configurationcsprotected override void OnModelCreating(DbModelBuilder modelBuilder) {\n    base.OnModelCreating(modelBuilder);\n\n    modelBuilder.Entity&lt;Message&gt;()\n        .HasRequired(m =&gt; m.User)\n        .WithMany()\n        .HasForeignKey(m =&gt; m.TenantId)\n        .WillCascadeOnDelete(true);\n\n    var conv = new AttributeToTableAnnotationConvention&lt;TenantAwareAttribute, string&gt;(\n                    TenantAwareAttribute.TenantAnnotation, (type, attributes) =&gt; attributes.Single().ColumnName);\n\n    modelBuilder.Conventions.Add(conv);\n}\n\n\nChanges in Message classAfter creating this infrastructure code the Message class can change and decorate it with the TenantAwareAttribute attribute as below:\nChanged Message POCOcs[TenantAware(\"TenantId\")]\npublic class Message {\n    public long Id { get; set; }\n    public string TenantId { get; private set; }\n    public virtual ApplicationUser User { get; set; }\n    [Required]\n    public string Description { get; set; }\n}\n\nAs we can see here there is another important change in the class. The TenantId property now is private set which means we can’t explicitly assign it from our code base. The last issue is quite important as we are not able to assign an invalid TenantId by mistake. Furthermore we don’t have to take care of assign a TenantId at all.\n\nThis was the first part of a series of three posts. It includes the problem and the infrastructure code for what is coming on the next posts. For those that can’t wait I have created a project in Github that contains the full code in a relatively change model. In the next post I will describe how we can use the code we already created to apply filtering based on TenantId always in a transparent way for our application.\nPart 2Part 3","dateCreated":"2014-11-17T23:15:00+02:00","dateModified":"2024-04-20T18:01:58+03:00","datePublished":"2014-11-17T23:15:00+02:00","description":"A highly increasing request we have to serve as developers, especially after Software as a Service revolution, is to provide software that is able to handle individual users in one application by separate each user’s data. This feature is called Multitenancy and there are several ways to achieve it. In this series of posts I will try to demonstrate how we can achieve the data isolation by using some advance features of Entity Framework.","headline":"Create a multitenant application with Entity Framework Code First - Part 1","image":[],"mainEntityOfPage":{"@type":"WebPage","@id":"https://xabikos.com/2014/11/17/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-1/"},"publisher":{"@type":"Organization","name":"Babis Karypidis","sameAs":["https://github.com/xabikos","http://stackoverflow.com/users/2326486/xabikos","https://twitter.com/xabikos","https://www.linkedin.com/in/charalamposkarypidis/","mailto:xaralaboskaripidis@gmail.com"],"image":"https://www.gravatar.com/avatar/7c9ee05396641133c8d505197fc17cc5","logo":{"@type":"ImageObject","url":"https://www.gravatar.com/avatar/7c9ee05396641133c8d505197fc17cc5"}},"url":"https://xabikos.com/2014/11/17/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-1/","keywords":"entity framework, multi-tenant, interceptors, code first"}</script>
    <meta name="description" content="A highly increasing request we have to serve as developers, especially after Software as a Service revolution, is to provide software that is able to handle individual users in one application by sepa">
<meta property="og:type" content="blog">
<meta property="og:title" content="Create a multitenant application with Entity Framework Code First - Part 1">
<meta property="og:url" content="https://xabikos.com/2014/11/17/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-1/index.html">
<meta property="og:site_name" content="Web development with asp.net and React.js">
<meta property="og:description" content="A highly increasing request we have to serve as developers, especially after Software as a Service revolution, is to provide software that is able to handle individual users in one application by sepa">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2014-11-17T21:15:00.000Z">
<meta property="article:modified_time" content="2024-04-20T15:01:58.566Z">
<meta property="article:author" content="Babis Karypidis">
<meta property="article:tag" content="entity framework">
<meta property="article:tag" content="multi-tenant">
<meta property="article:tag" content="interceptors">
<meta property="article:tag" content="code first">
<meta name="twitter:card" content="summary">
<meta name="twitter:creator" content="@xabikos">
    
    
        
    
    
        <meta property="og:image" content="https://www.gravatar.com/avatar/7c9ee05396641133c8d505197fc17cc5?s=640"/>
    
    
    
    
    <!--STYLES-->
    
<link rel="stylesheet" href="/assets/css/style-ivrygzl3rwlgzyajt80wrlhh1ioidhvuus4od2whngmbzmqtexp2vzrqzxtw.min.css">

    <!--STYLES END-->
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-56484404-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-56484404-1');
    </script>


    

    
        
    
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    
        
    

<header id="header" data-behavior="5">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a
            class="header-title-link"
            href="/"
            aria-label=""
        >
            Web development with asp.net and React.js
        </a>
    </div>
    
        
            <a
                class="header-right-picture "
                href="#about"
                aria-label="Open the link: /#about"
            >
        
        
            <img class="header-picture" src="https://www.gravatar.com/avatar/7c9ee05396641133c8d505197fc17cc5?s=90" alt="Author&#39;s picture"/>
        
        </a>
    
</header>

            <!-- Define author's picture -->


    

<nav id="sidebar" data-behavior="5">
    <div class="sidebar-container">
        
            <div class="sidebar-profile">
                <a
                    href="/#about"
                    aria-label="Read more about the author"
                >
                    <img class="sidebar-profile-picture" src="https://www.gravatar.com/avatar/7c9ee05396641133c8d505197fc17cc5?s=110" alt="Author&#39;s picture"/>
                </a>
                <h4 class="sidebar-profile-name">Babis Karypidis</h4>
                
                    <h5 class="sidebar-profile-bio"><p>Hi, I am Babis Karypidis, a Greek software engineer who tries to fit other activities, except development, in his life.</p>
</h5>
                
            </div>
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/"
                            
                            rel="noopener"
                            title="Home"
                        >
                        <i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Home</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-categories"
                            
                            rel="noopener"
                            title="Categories"
                        >
                        <i class="sidebar-button-icon fa fa-bookmark" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Categories</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-tags"
                            
                            rel="noopener"
                            title="Tags"
                        >
                        <i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Tags</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="#about"
                            
                            rel="noopener"
                            title="About"
                        >
                        <i class="sidebar-button-icon fa fa-question" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">About</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://github.com/xabikos"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="GitHub"
                        >
                        <i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="http://stackoverflow.com/users/2326486/xabikos"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="Stack Overflow"
                        >
                        <i class="sidebar-button-icon fab fa-stack-overflow" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Stack Overflow</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://twitter.com/xabikos"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="Twitter"
                        >
                        <i class="sidebar-button-icon fab fa-twitter" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Twitter</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://www.linkedin.com/in/charalamposkarypidis/"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="LinkedIn"
                        >
                        <i class="sidebar-button-icon fab fa-linkedin" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">LinkedIn</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="mailto:xaralaboskaripidis@gmail.com"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="Mail"
                        >
                        <i class="sidebar-button-icon fa fa-envelope" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Mail</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/atom.xml"
                            
                            rel="noopener"
                            title="RSS"
                        >
                        <i class="sidebar-button-icon fa fa-rss" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">RSS</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
            <div id="main" data-behavior="5"
                 class="
                        hasCoverMetaIn
                        ">
                
<article class="post">
    
    
        <div class="post-header main-content-wrap text-left">
    
        <h1 class="post-title">
            Create a multitenant application with Entity Framework Code First - Part 1
        </h1>
    
    
        <div class="post-meta">
    <time datetime="2014-11-17T23:15:00+02:00">
	
		    Nov 17, 2014
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/multitenant/">multitenant</a>, <a class="category-link" href="/categories/multitenant/application-design/">application design</a>, <a class="category-link" href="/categories/multitenant/application-design/software-as-a-service/">software as a service</a>


    
</div>

    
</div>

    
    <div class="post-content markdown">
        <div class="main-content-wrap">
            <p>A highly increasing request we have to serve as developers, especially after Software as a Service revolution, is to provide software that is able to handle individual users in one application by separate each user’s data. This feature is called <a target="_blank" rel="noopener" href="http://en.wikipedia.org/wiki/Multitenancy">Multitenancy</a> and there are several ways to achieve it. In this series of posts I will try to demonstrate how we can achieve the data isolation by using some advance features of Entity Framework.</p>
<span id="more"></span>
<hr>
<h4 id="The-really-simple-model"><a href="#The-really-simple-model" class="headerlink" title="The really simple model"></a>The really simple model</h4><p>The first part includes the description of the model used across the application. Lets assume we want to manage some Messages for our application and each logged in user should be able to access and modify only his personal messages. The Message is a classic <a target="_blank" rel="noopener" href="http://en.wikipedia.org/wiki/Plain_Old_CLR_Object">POCO</a> class that doesn’t have any Entity Framework specific code as you can see in the snippet below.</p>
<figure class="codeblock codeblock--tabbed"><figcaption><span>Message POCO</span><ul class="tabs"><li class="tab active">cs</li></ul></figcaption><div class="tabs-content"><pre style="display: block;"><code>public class Message {
    public long Id { get; set; }
    public string TenantId { get; set; }
    public virtual ApplicationUser User { get; set; }
    [Required]
    public string Description { get; set; }
}</code></pre></div></figure>

<p>We follow mainly the convention over configuration approach Entity Framework provides and the only explicit configuration we have to apply in our Message class is to declare TenantId as foreign key for User property by adding the code that follows in the DbContext class we are going to use for data access.</p>
<figure class="codeblock codeblock--tabbed"><figcaption><span>Entity configuration</span><ul class="tabs"><li class="tab active">cs</li></ul></figcaption><div class="tabs-content"><pre style="display: block;"><code>protected override void OnModelCreating(DbModelBuilder modelBuilder) {
    base.OnModelCreating(modelBuilder);

    modelBuilder.Entity&lt;Message&gt;()
        .HasRequired(m =&gt; m.User)
        .WithMany()
        .HasForeignKey(m =&gt; m.TenantId)
        .WillCascadeOnDelete(true);
}</code></pre></div></figure>

<hr>
<h4 id="The-“manual”-approach"><a href="#The-“manual”-approach" class="headerlink" title="The “manual” approach"></a>The “manual” approach</h4><p>I will first implement an MVC Controller that includes the logic of filtering based on TenantId and assign the correct TenantId when creating a new message. The code we have to write is more or less like the snippet below:</p>
<figure class="codeblock codeblock--tabbed"><figcaption><span>Controller</span><ul class="tabs"><li class="tab active">cs</li></ul></figcaption><div class="tabs-content"><pre style="display: block;"><code>[Authorize]
public class MessagesController : Controller {
    private ApplicationDbContext db = new ApplicationDbContext();

    private string UserId { get { return User.Identity.IsAuthenticated ? User.Identity.GetUserId() : string.Empty; }}

    public ActionResult Index() {
        // Tenant specific query logic
        var messages = db.Messages.Include(m =&gt; m.User).Where(m =&gt; m.TenantId == UserId);
        return View(messages.ToList());
    }

    public ActionResult Details(long? id) {
        // Tenant specific query logic
        Message message = db.Messages.SingleOrDefault(m =&gt; m.Id == id &amp;&amp; m.TenantId == UserId);
        if (message == null) {
            return HttpNotFound();
        }
        return View(message);
    }

    public ActionResult Create([Bind(Include = "Id,Description")] Message message) {
        if (ModelState.IsValid) {
            // Assign tenant Id explicitly
            message.TenantId = UserId;
            db.Messages.Add(message);
            db.SaveChanges();
            return RedirectToAction("Index");
        }
        return View(message);
    }

    public ActionResult Edit(long? id) {
        // Tenant specific query logic
        Message message = db.Messages.SingleOrDefault(m =&gt; m.Id == id &amp;&amp; m.TenantId == UserId);
        if (message == null) {
            return HttpNotFound();
        }
        return View(message);
    }

    public ActionResult Edit([Bind(Include = "Id,Description")] Message message) {
        if (ModelState.IsValid) {
            // Assign tenant Id explicitly
            message.TenantId = UserId;
            db.Entry(message).State = EntityState.Modified;
            db.SaveChanges();
            return RedirectToAction("Index");
        }
        return View(message);
    }
}</code></pre></div></figure>

<p>I didn’t include all required logic and also removed the delete functionality but the problem of always remember to filter the correct data is obvious. On top of this we must assign the TenantId property explicitly as the user should not be able to do something like this. This approach is of course a valid solution but requires a lot of repetition of the same logic throughout our application something that is always error prone. On top of this the entire application has knowledge of the TenantId concept. We could solve this problem by creating a base class, something like base Repository or similar approach, and hide this detail there. This would definitely improve the design but still when the base class is not enough we have to remember to apply the filtering.</p>
<hr>
<h4 id="Entity-Framework-Interceptors"><a href="#Entity-Framework-Interceptors" class="headerlink" title="Entity Framework Interceptors"></a>Entity Framework Interceptors</h4><p><a target="_blank" rel="noopener" href="http://msdn.microsoft.com/en-us/data/dn469464.aspx#BuildingBlocks">Entity Framework Interceptors</a> is a very powerful feature added in version 6 of the framework and we can use them in order to hide the filtering and assign the correct TenantId in only one place. To be able to do that we must first write some infrastructure code.</p>
<hr>
<h4 id="TenantAwareAttribute-and-custom-convention"><a href="#TenantAwareAttribute-and-custom-convention" class="headerlink" title="TenantAwareAttribute and custom convention"></a>TenantAwareAttribute and custom convention</h4><p>The first step is to create an ordinary attribute class with which we can annotate our classes in order to get the Tenant functionality automatically. The code for the attribute class is shown below:</p>
<figure class="codeblock codeblock--tabbed"><figcaption><span>Custom Attribute</span><ul class="tabs"><li class="tab active">cs</li></ul></figcaption><div class="tabs-content"><pre style="display: block;"><code>[AttributeUsage(AttributeTargets.Class, AllowMultiple = false)]
public class TenantAwareAttribute : Attribute {
    public const string TenantAnnotation = "TenantAnnotation";
    public const string TenantIdFilterParameterName = "TenantIdParameter";

    public string ColumnName { get; private set; }

    public TenantAwareAttribute(string columnName) {
        ColumnName = columnName;
    }

    public static string GetTenantColumnName(EdmType type) {
        MetadataProperty annotation = type.MetadataProperties.SingleOrDefault(
            p =&gt; p.Name.EndsWith(string.Format("customannotation:{0}", TenantAnnotation)));

        return annotation == null ? null : (string)annotation.Value;
    }
}</code></pre></div></figure>

<p>When using this attribute we have to declare which property of the class is the one responsible for TenantId. Moreover exposes a static helper method to get the the tenant column name based on the EdmType.</p>
<p>The next step is to use this attribute by adding a custom <a target="_blank" rel="noopener" href="http://msdn.microsoft.com/en-us/data/jj819164.aspx">Entity Framework convention</a> to the DbContext class we are going to use for data access in our application. To do this we have to add the code snippet below on the DbContext class.</p>
<figure class="codeblock codeblock--tabbed"><figcaption><span>Add attribute to configuration</span><ul class="tabs"><li class="tab active">cs</li></ul></figcaption><div class="tabs-content"><pre style="display: block;"><code>protected override void OnModelCreating(DbModelBuilder modelBuilder) {
    base.OnModelCreating(modelBuilder);

    modelBuilder.Entity&lt;Message&gt;()
        .HasRequired(m =&gt; m.User)
        .WithMany()
        .HasForeignKey(m =&gt; m.TenantId)
        .WillCascadeOnDelete(true);

    var conv = new AttributeToTableAnnotationConvention&lt;TenantAwareAttribute, string&gt;(
                    TenantAwareAttribute.TenantAnnotation, (type, attributes) =&gt; attributes.Single().ColumnName);

    modelBuilder.Conventions.Add(conv);
}</code></pre></div></figure>

<hr>
<h4 id="Changes-in-Message-class"><a href="#Changes-in-Message-class" class="headerlink" title="Changes in Message class"></a>Changes in Message class</h4><p>After creating this infrastructure code the Message class can change and decorate it with the TenantAwareAttribute attribute as below:</p>
<figure class="codeblock codeblock--tabbed"><figcaption><span>Changed Message POCO</span><ul class="tabs"><li class="tab active">cs</li></ul></figcaption><div class="tabs-content"><pre style="display: block;"><code>[TenantAware("TenantId")]
public class Message {
    public long Id { get; set; }
    public string TenantId { get; private set; }
    public virtual ApplicationUser User { get; set; }
    [Required]
    public string Description { get; set; }
}</code></pre></div></figure>

<p>As we can see here there is another important change in the class. The TenantId property now is private set which means we can’t explicitly assign it from our code base. The last issue is quite important as we are not able to assign an invalid TenantId by mistake. Furthermore we don’t have to take care of assign a TenantId at all.</p>
<hr>
<p>This was the first part of a series of three posts. It includes the problem and the infrastructure code for what is coming on the next posts. For those that can’t wait I have created a <a target="_blank" rel="noopener" href="https://github.com/xabikos/EfMultitenant">project in Github</a> that contains the full code in a relatively change model. In the next post I will describe how we can use the code we already created to apply filtering based on TenantId always in a transparent way for our application.</p>
<h3 id="Part-2"><a href="#Part-2" class="headerlink" title="Part 2"></a><a href="/2014/11/18/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-2/">Part 2</a></h3><h3 id="Part-3"><a href="#Part-3" class="headerlink" title="Part 3"></a><a href="/2014/11/19/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-3/">Part 3</a></h3>
            


        </div>
    </div>
    <div id="post-footer" class="post-footer main-content-wrap">
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">TAGGED IN</span><br/>
                
    <a class="tag tag--primary tag--small t-none-link" href="/tags/code-first/" rel="tag">code first</a> <a class="tag tag--primary tag--small t-none-link" href="/tags/entity-framework/" rel="tag">entity framework</a> <a class="tag tag--primary tag--small t-none-link" href="/tags/interceptors/" rel="tag">interceptors</a> <a class="tag tag--primary tag--small t-none-link" href="/tags/multi-tenant/" rel="tag">multi-tenant</a>

            </div>
        
        
            <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2014/11/18/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-2/"
                    data-tooltip="Create a multitenant application with Entity Framework Code First - Part 2"
                    aria-label="PREVIOUS: Create a multitenant application with Entity Framework Code First - Part 2"
                >
                    
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2014/11/05/user-confirmed-filter-attribute/"
                    data-tooltip="ASP.NET User confirmed email filter attribute"
                    aria-label="NEXT: ASP.NET User confirmed email filter attribute"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="Share this post"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://xabikos.com/2014/11/17/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-1/"
                    title="Share on Facebook"
                    aria-label="Share on Facebook"
                >
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=https://xabikos.com/2014/11/17/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-1/"
                    title="Share on Twitter"
                    aria-label="Share on Twitter"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
                <li class="post-action">
                    <a
                        class="post-action-btn btn btn--default"
                        href="#disqus_thread"
                        aria-label="Leave a comment"
                    >
                        <i class="fa fa-comment"></i>
                    </a>
                </li>
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="Back to top">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


        
        
            
                <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
            
        
    </div>
</article>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2024 Babis Karypidis. All Rights Reserved.
    </span>
</footer>

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="5">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2014/11/18/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-2/"
                    data-tooltip="Create a multitenant application with Entity Framework Code First - Part 2"
                    aria-label="PREVIOUS: Create a multitenant application with Entity Framework Code First - Part 2"
                >
                    
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2014/11/05/user-confirmed-filter-attribute/"
                    data-tooltip="ASP.NET User confirmed email filter attribute"
                    aria-label="NEXT: ASP.NET User confirmed email filter attribute"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="Share this post"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://xabikos.com/2014/11/17/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-1/"
                    title="Share on Facebook"
                    aria-label="Share on Facebook"
                >
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=https://xabikos.com/2014/11/17/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-1/"
                    title="Share on Twitter"
                    aria-label="Share on Twitter"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
                <li class="post-action">
                    <a
                        class="post-action-btn btn btn--default"
                        href="#disqus_thread"
                        aria-label="Leave a comment"
                    >
                        <i class="fa fa-comment"></i>
                    </a>
                </li>
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="Back to top">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


                </div>
                
    <div id="share-options-bar" class="share-options-bar" data-behavior="5">
        <i id="btn-close-shareoptions" class="fa fa-times"></i>
        <ul class="share-options">
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://www.facebook.com/sharer/sharer.php?u=https://xabikos.com/2014/11/17/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-1/"
                        aria-label="Share on Facebook"
                    >
                        <i class="fab fa-facebook" aria-hidden="true"></i><span>Share on Facebook</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://twitter.com/intent/tweet?text=https://xabikos.com/2014/11/17/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-1/"
                        aria-label="Share on Twitter"
                    >
                        <i class="fab fa-twitter" aria-hidden="true"></i><span>Share on Twitter</span>
                    </a>
                </li>
            
        </ul>
    </div>


            
        </div>
        


    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <img id="about-card-picture" src="https://www.gravatar.com/avatar/7c9ee05396641133c8d505197fc17cc5?s=110" alt="Author&#39;s picture"/>
        
            <h4 id="about-card-name">Babis Karypidis</h4>
        
            <div id="about-card-bio"><p>Hi, I am Babis Karypidis, a Greek software engineer who tries to fit other activities, except development, in his life.</p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>Freelance Software Engineer focusing on .NET, Azure and React.js</p>

            </div>
        
        
            <div id="about-card-location">
                <i class="fa fa-map-marker-alt"></i>
                <br/>
                Thessaloniki, Greece
            </div>
        
    </div>
</div>

        
        
<div id="cover" style="background-image:url('/assets/images/cover.jpg');"></div>
        <!--SCRIPTS-->

<script src="/assets/js/script-yyz2rnzpilmc2udfgqml9ilwziu3ydccm9bogkls7cijrn6iwnrwirlgdjmo.min.js"></script>

<!--SCRIPTS END-->


    
        <script>
          var disqus_config = function() {
            this.page.url = 'https://xabikos.com/2014/11/17/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-1/';
              
            this.page.identifier = '2014/11/17/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-1/';
              
          };
          (function() {
            var d = document, s = d.createElement('script');
            var disqus_shortname = 'xabikos';
            s.src = '//' + disqus_shortname + '.disqus.com/embed.js';

            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
          })();
        </script>
    




    </body>
</html>
