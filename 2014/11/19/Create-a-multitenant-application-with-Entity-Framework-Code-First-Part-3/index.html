
<!DOCTYPE html>
<html lang="en">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Web development with asp.net and React.js">
    <title>Create a multitenant application with Entity Framework Code First - Part 3 - Web development with asp.net and React.js</title>
    <meta name="author" content="Babis Karypidis">
    
        <meta name="keywords" content="entity framework,multitenant,code first">
    
    
    
        
            <link rel="alternate" type="application/atom+xml" title="RSS" href="/atom.xml">
        
    
    <script type="application/ld+json">{"@context":"http://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Babis Karypidis","sameAs":["https://github.com/xabikos","http://stackoverflow.com/users/2326486/xabikos","https://twitter.com/xabikos","https://www.linkedin.com/in/charalamposkarypidis/","mailto:xaralaboskaripidis@gmail.com"],"image":"https://www.gravatar.com/avatar/7c9ee05396641133c8d505197fc17cc5"},"articleBody":"Connection with previous postsThis is the last post of the series of how we can use Entity Framework Code First to create a multitenant application. You are requested first to read Part 1 where there is an introduction in the problem we are trying to solve and some infrastructure code required to continue. Part 2 describes the query filtering that is happening automatically in the entire application. In this post I am going to show how we can use the CommandTree interceptor in order to modify the insert, update and delete commands. The idea of implement something like this came to my mind after watching Rowan Miller’s excellent session in North America TechEd, which I highly recommend you to watch.\n\n\nModification of insert commandLet’s start by presenting the code of insert command which is probably the simplest case. What we want to achieve is to always assign the correct TenantId when saving an entity that has this property. I have to remind here that Message class has a private set in TenantId property so there is no way to assign it from the code base.\nInsert command interceptorcspublic class TenantCommandTreeInterceptor : IDbCommandTreeInterceptor {\n    public void TreeCreated(DbCommandTreeInterceptionContext interceptionContext) {\n        if (interceptionContext.OriginalResult.DataSpace == DataSpace.SSpace) {\n            // Check that there is an authenticated user in this context\n            var identity = Thread.CurrentPrincipal.Identity as ClaimsIdentity;\n            if (identity == null){\n                return;\n            }\n            var userIdclaim = identity.Claims.SingleOrDefault(c =&gt; c.Type == ClaimTypes.NameIdentifier);\n            if (userIdclaim == null) {\n                return;\n            }\n            var userId = userIdclaim.Value;\n\n            var insertCommand = interceptionContext.Result as DbInsertCommandTree;\n            if (insertCommand != null) {\n                var column = TenantAwareAttribute.GetTenantColumnName(insertCommand.Target.VariableType.EdmType);\n                if (!string.IsNullOrEmpty(column)) {\n                    // Create the variable reference in order to create the property\n                    var variableReference = DbExpressionBuilder.Variable(insertCommand.Target.VariableType,\n                        insertCommand.Target.VariableName);\n                    // Create the property to which will assign the correct value\n                    var tenantProperty = DbExpressionBuilder.Property(variableReference, column);\n                    // Create the set clause, object representation of sql insert command\n                    var tenantSetClause =\n                        DbExpressionBuilder.SetClause(tenantProperty, DbExpression.FromString(userId));\n\n                    // Remove potential assignment of tenantId for extra safety\n                    var filteredSetClauses =\n                        insertCommand.SetClauses.Cast&lt;DbSetClause&gt;()\n                            .Where(sc =&gt; ((DbPropertyExpression)sc.Property).Property.Name != column);\n\n                    // Construct the final clauses, object representation of sql insert command values\n                    var finalSetClauses =\n                        new ReadOnlyCollection&lt;DbModificationClause&gt;\n                        (new List&lt;DbModificationClause&gt;(filteredSetClauses) {\n                            tenantSetClause\n                        });\n\n                    var newInsertCommand = new DbInsertCommandTree(\n                        insertCommand.MetadataWorkspace,\n                        insertCommand.DataSpace,\n                        insertCommand.Target,\n                        finalSetClauses,\n                        insertCommand.Returning);\n\n                    interceptionContext.Result = newInsertCommand;\n                    return;\n                }\n            }\n        }\n    }\n}\n\nThe most important piece of code is where we create the set clause. To further explain this is an object representation of a SQL pair values like INSERT INTO TABLE (TenantId) VALUE (the value of tenantId). After doing this we filter the original collection of set clause and remove any possible existence of the same set clause. As a final step we create a new insert command by assigning the original values and replacing only the set clause. The interception ends by setting the result explicitly.\n\nModification of update commandNow we have to modify any update command that is sent to the database and remove any change in the value of tenantId and add an extra where statement based on the tenantId. So after the interception any SQL update command is going to have an extra and statement like AND TenantId &#x3D; ‘value of tenantId’.\nUpdate command interceptorcspublic class TenantCommandTreeInterceptor : IDbCommandTreeInterceptor {\n    public void TreeCreated(DbCommandTreeInterceptionContext interceptionContext) {\n        if (interceptionContext.OriginalResult.DataSpace == DataSpace.SSpace) {\n            // Check that there is an authenticated user in this context\n            var identity = Thread.CurrentPrincipal.Identity as ClaimsIdentity;\n            if (identity == null){\n                return;\n            }\n            var userIdclaim = identity.Claims.SingleOrDefault(c =&gt; c.Type == ClaimTypes.NameIdentifier);\n            if (userIdclaim == null) {\n                return;\n            }\n            var userId = userIdclaim.Value;\n            var updateCommand = interceptionContext.Result as DbUpdateCommandTree;\n            if (updateCommand != null) {\n                var column = TenantAwareAttribute.GetTenantColumnName(updateCommand.Target.VariableType.EdmType);\n                if (!string.IsNullOrEmpty(column)){\n                    // Create the variable reference in order to create the property\n                    var variableReference = DbExpressionBuilder.Variable(updateCommand.Target.VariableType,\n                        updateCommand.Target.VariableName);\n                    // Create the property to which will assign the correct value\n                    var tenantProperty = DbExpressionBuilder.Property(variableReference, column);\n                    // Create the tenantId where predicate, object representation of sql where tenantId = value statement\n                    var tenantIdWherePredicate = DbExpressionBuilder.Equal(tenantProperty, DbExpression.FromString(userId));\n\n                    // Remove potential assignment of tenantId for extra safety\n                    var filteredSetClauses =\n                        updateCommand.SetClauses.Cast&lt;DbSetClause&gt;()\n                            .Where(sc =&gt; ((DbPropertyExpression)sc.Property).Property.Name != column);\n\n                    // Construct the final clauses, object representation of sql insert command values\n                    var finalSetClauses =\n                        new ReadOnlyCollection&lt;DbModificationClause&gt;(new List&lt;DbModificationClause&gt;(filteredSetClauses));\n\n                    // The initial predicate is the sql where statement\n                    var initialPredicate = updateCommand.Predicate;\n                    // Add to the initial statement the tenantId statement which translates in sql AND TenantId = 'value'\n                    var finalPredicate = initialPredicate.And(tenantIdWherePredicate);\n\n                    var newUpdateCommand = new DbUpdateCommandTree(\n                        updateCommand.MetadataWorkspace,\n                        updateCommand.DataSpace,\n                        updateCommand.Target,\n                        finalPredicate,\n                        finalSetClauses,\n                        updateCommand.Returning);\n\n                    interceptionContext.Result = newUpdateCommand;\n                    return;\n                }\n            }\n        }\n    }\n}\n\nThe first part of the code is exactly the same as the interception in insert command. The only difference here is that we don’t create another set clause but a predicate which is the object representation of the SQL And statement. We explicitly do a logical AND with the original predicate and assign the final predicate in the new update command we construct.\n\nModification of delete commandThe last piece to finish the puzzle is to modify the delete command before travelling to the database. The goal is exactly the same with update command. We want to append an extra where SQL statement in all delete commands. The code is also the same as in update command.\nDelete command interceptorcspublic class TenantCommandTreeInterceptor : IDbCommandTreeInterceptor {\n    public void TreeCreated(DbCommandTreeInterceptionContext interceptionContext) {\n        if (interceptionContext.OriginalResult.DataSpace == DataSpace.SSpace) {\n            // Check that there is an authenticated user in this context\n            var identity = Thread.CurrentPrincipal.Identity as ClaimsIdentity;\n            if (identity == null){\n                return;\n            }\n            var userIdclaim = identity.Claims.SingleOrDefault(c =&gt; c.Type == ClaimTypes.NameIdentifier);\n            if (userIdclaim == null) {\n                return;\n            }\n            var userId = userIdclaim.Value;\n\n            var deleteCommand = interceptionContext.Result as DbDeleteCommandTree;\n            if (deleteCommand != null){\n                var column = TenantAwareAttribute.GetTenantColumnName(deleteCommand.Target.VariableType.EdmType);\n                if (!string.IsNullOrEmpty(column)){\n                    // Create the variable reference in order to create the property\n                    var variableReference = DbExpressionBuilder.Variable(deleteCommand.Target.VariableType,\n                        deleteCommand.Target.VariableName);\n                    // Create the property to which will assign the correct value\n                    var tenantProperty = DbExpressionBuilder.Property(variableReference, column);\n                    var tenantIdWherePredicate = DbExpressionBuilder.Equal(tenantProperty, DbExpression.FromString(userId));\n\n                    // The initial predicate is the sql where statement\n                    var initialPredicate = deleteCommand.Predicate;\n                    // Add to the initial statement the tenantId statement which translates in sql AND TenantId = 'value'\n                    var finalPredicate = initialPredicate.And(tenantIdWherePredicate);\n\n                    var newDeleteCommand = new DbDeleteCommandTree(\n                        deleteCommand.MetadataWorkspace,\n                        deleteCommand.DataSpace,\n                        deleteCommand.Target,\n                        finalPredicate);\n\n                    interceptionContext.Result = newDeleteCommand;\n                    return ;\n                }\n            }\n        }\n    }\n}\n\nWe create manually again a predicate and do a logical AND with the original predicate of the command. After this we creating a new delete command and assign it as the interception result. There is no need to create different interceptors class per command of course. We can combine all of them in just one class as you can see in this example.\n\nFinal thoughtsThis was the last part of a series of posts. You can find the first part here and the second here. I hope that these posts will become useful to other developers as this is the way we solved the multi tenancy data access problem in the project I am currently working on. Any comments or thoughts to improve the code are more than welcome. As I mentioned in the previous posts I have a public Github repository that contains a full project with the demonstrated code.\nPart 1Part 2","dateCreated":"2014-11-19T20:15:00+02:00","dateModified":"2024-04-20T18:01:58+03:00","datePublished":"2014-11-19T20:15:00+02:00","description":"Connection with previous postsThis is the last post of the series of how we can use Entity Framework Code First to create a multitenant application. You are requested first to read Part 1 where there is an introduction in the problem we are trying to solve and some infrastructure code required to continue. Part 2 describes the query filtering that is happening automatically in the entire application. In this post I am going to show how we can use the CommandTree interceptor in order to modify the insert, update and delete commands. The idea of implement something like this came to my mind after watching Rowan Miller’s excellent session in North America TechEd, which I highly recommend you to watch.","headline":"Create a multitenant application with Entity Framework Code First - Part 3","image":[],"mainEntityOfPage":{"@type":"WebPage","@id":"https://xabikos.com/2014/11/19/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-3/"},"publisher":{"@type":"Organization","name":"Babis Karypidis","sameAs":["https://github.com/xabikos","http://stackoverflow.com/users/2326486/xabikos","https://twitter.com/xabikos","https://www.linkedin.com/in/charalamposkarypidis/","mailto:xaralaboskaripidis@gmail.com"],"image":"https://www.gravatar.com/avatar/7c9ee05396641133c8d505197fc17cc5","logo":{"@type":"ImageObject","url":"https://www.gravatar.com/avatar/7c9ee05396641133c8d505197fc17cc5"}},"url":"https://xabikos.com/2014/11/19/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-3/","keywords":"entity framework, multi-tenant, interceptors, code first"}</script>
    <meta name="description" content="Connection with previous postsThis is the last post of the series of how we can use Entity Framework Code First to create a multitenant application. You are requested first to read Part 1 where there">
<meta property="og:type" content="blog">
<meta property="og:title" content="Create a multitenant application with Entity Framework Code First - Part 3">
<meta property="og:url" content="https://xabikos.com/2014/11/19/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-3/index.html">
<meta property="og:site_name" content="Web development with asp.net and React.js">
<meta property="og:description" content="Connection with previous postsThis is the last post of the series of how we can use Entity Framework Code First to create a multitenant application. You are requested first to read Part 1 where there">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2014-11-19T18:15:00.000Z">
<meta property="article:modified_time" content="2024-04-20T15:01:58.567Z">
<meta property="article:author" content="Babis Karypidis">
<meta property="article:tag" content="entity framework">
<meta property="article:tag" content="multi-tenant">
<meta property="article:tag" content="interceptors">
<meta property="article:tag" content="code first">
<meta name="twitter:card" content="summary">
<meta name="twitter:creator" content="@xabikos">
    
    
        
    
    
        <meta property="og:image" content="https://www.gravatar.com/avatar/7c9ee05396641133c8d505197fc17cc5?s=640"/>
    
    
    
    
    <!--STYLES-->
    
<link rel="stylesheet" href="/assets/css/style-l75e9pkst9f5hq5irx80zjnvasnb2rnqxprrbw9gnxafornapyufpp3d5poq.min.css">

    <!--STYLES END-->
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-56484404-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-56484404-1');
    </script>


    

    
        
    
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    
        
    

<header id="header" data-behavior="5">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a
            class="header-title-link"
            href="/"
            aria-label=""
        >
            Web development with asp.net and React.js
        </a>
    </div>
    
        
            <a
                class="header-right-picture "
                href="#about"
                aria-label="Open the link: /#about"
            >
        
        
            <img class="header-picture" src="https://www.gravatar.com/avatar/7c9ee05396641133c8d505197fc17cc5?s=90" alt="Author&#39;s picture"/>
        
        </a>
    
</header>

            <!-- Define author's picture -->


    

<nav id="sidebar" data-behavior="5">
    <div class="sidebar-container">
        
            <div class="sidebar-profile">
                <a
                    href="/#about"
                    aria-label="Read more about the author"
                >
                    <img class="sidebar-profile-picture" src="https://www.gravatar.com/avatar/7c9ee05396641133c8d505197fc17cc5?s=110" alt="Author&#39;s picture"/>
                </a>
                <h4 class="sidebar-profile-name">Babis Karypidis</h4>
                
                    <h5 class="sidebar-profile-bio"><p>author.bio</p>
</h5>
                
            </div>
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/"
                            
                            rel="noopener"
                            title="Home"
                        >
                        <i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Home</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-categories"
                            
                            rel="noopener"
                            title="Categories"
                        >
                        <i class="sidebar-button-icon fa fa-bookmark" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Categories</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-tags"
                            
                            rel="noopener"
                            title="Tags"
                        >
                        <i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Tags</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-archives"
                            
                            rel="noopener"
                            title="Archives"
                        >
                        <i class="sidebar-button-icon fa fa-archive" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Archives</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link open-algolia-search"
                            href="#search"
                            
                            rel="noopener"
                            title="Search"
                        >
                        <i class="sidebar-button-icon fa fa-search" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Search</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="#about"
                            
                            rel="noopener"
                            title="About"
                        >
                        <i class="sidebar-button-icon fa fa-question" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">About</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://github.com/xabikos"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="GitHub"
                        >
                        <i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="http://stackoverflow.com/users/2326486/xabikos"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="Stack Overflow"
                        >
                        <i class="sidebar-button-icon fab fa-stack-overflow" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Stack Overflow</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://twitter.com/xabikos"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="Twitter"
                        >
                        <i class="sidebar-button-icon fab fa-twitter" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Twitter</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://www.linkedin.com/in/charalamposkarypidis/"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="LinkedIn"
                        >
                        <i class="sidebar-button-icon fab fa-linkedin" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">LinkedIn</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="mailto:xaralaboskaripidis@gmail.com"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="Mail"
                        >
                        <i class="sidebar-button-icon fa fa-envelope" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Mail</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/atom.xml"
                            
                            rel="noopener"
                            title="RSS"
                        >
                        <i class="sidebar-button-icon fa fa-rss" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">RSS</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
            <div id="main" data-behavior="5"
                 class="
                        hasCoverMetaIn
                        ">
                
<article class="post">
    
    
        <div class="post-header main-content-wrap text-left">
    
        <h1 class="post-title">
            Create a multitenant application with Entity Framework Code First - Part 3
        </h1>
    
    
        <div class="post-meta">
    <time datetime="2014-11-19T20:15:00+02:00">
	
		    Nov 19, 2014
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/multitenant/">multitenant</a>, <a class="category-link" href="/categories/multitenant/application-design/">application design</a>, <a class="category-link" href="/categories/multitenant/application-design/software-as-a-service/">software as a service</a>


    
</div>

    
</div>

    
    <div class="post-content markdown">
        <div class="main-content-wrap">
            <h4 id="Connection-with-previous-posts"><a href="#Connection-with-previous-posts" class="headerlink" title="Connection with previous posts"></a>Connection with previous posts</h4><p>This is the last post of the series of how we can use Entity Framework Code First to create a multitenant application. You are requested first to read <a href="/2014/11/17/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-1/">Part 1</a> where there is an introduction in the problem we are trying to solve and some infrastructure code required to continue. <a href="/2014/11/18/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-2/">Part 2</a> describes the query filtering that is happening automatically in the entire application. In this post I am going to show how we can use the CommandTree interceptor in order to modify the insert, update and delete commands. The idea of implement something like this came to my mind after watching <a target="_blank" rel="noopener" href="http://romiller.com/">Rowan Miller’s</a> excellent <a target="_blank" rel="noopener" href="http://channel9.msdn.com/Events/TechEd/NorthAmerica/2014/DEV-B417#fbid=">session</a> in North America TechEd, which I highly recommend you to watch.</p>
<span id="more"></span>
<hr>
<h4 id="Modification-of-insert-command"><a href="#Modification-of-insert-command" class="headerlink" title="Modification of insert command"></a>Modification of insert command</h4><p>Let’s start by presenting the code of insert command which is probably the simplest case. What we want to achieve is to always assign the correct TenantId when saving an entity that has this property. I have to remind here that Message class has a private set in TenantId property so there is no way to assign it from the code base.</p>
<figure class="codeblock codeblock--tabbed"><figcaption><span>Insert command interceptor</span><ul class="tabs"><li class="tab active">cs</li></ul></figcaption><div class="tabs-content"><pre style="display: block;"><code>public class TenantCommandTreeInterceptor : IDbCommandTreeInterceptor {
    public void TreeCreated(DbCommandTreeInterceptionContext interceptionContext) {
        if (interceptionContext.OriginalResult.DataSpace == DataSpace.SSpace) {
            // Check that there is an authenticated user in this context
            var identity = Thread.CurrentPrincipal.Identity as ClaimsIdentity;
            if (identity == null){
                return;
            }
            var userIdclaim = identity.Claims.SingleOrDefault(c =&gt; c.Type == ClaimTypes.NameIdentifier);
            if (userIdclaim == null) {
                return;
            }
            var userId = userIdclaim.Value;

            var insertCommand = interceptionContext.Result as DbInsertCommandTree;
            if (insertCommand != null) {
                var column = TenantAwareAttribute.GetTenantColumnName(insertCommand.Target.VariableType.EdmType);
                if (!string.IsNullOrEmpty(column)) {
                    // Create the variable reference in order to create the property
                    var variableReference = DbExpressionBuilder.Variable(insertCommand.Target.VariableType,
                        insertCommand.Target.VariableName);
                    // Create the property to which will assign the correct value
                    var tenantProperty = DbExpressionBuilder.Property(variableReference, column);
                    // Create the set clause, object representation of sql insert command
                    var tenantSetClause =
                        DbExpressionBuilder.SetClause(tenantProperty, DbExpression.FromString(userId));

                    // Remove potential assignment of tenantId for extra safety
                    var filteredSetClauses =
                        insertCommand.SetClauses.Cast&lt;DbSetClause&gt;()
                            .Where(sc =&gt; ((DbPropertyExpression)sc.Property).Property.Name != column);

                    // Construct the final clauses, object representation of sql insert command values
                    var finalSetClauses =
                        new ReadOnlyCollection&lt;DbModificationClause&gt;
                        (new List&lt;DbModificationClause&gt;(filteredSetClauses) {
                            tenantSetClause
                        });

                    var newInsertCommand = new DbInsertCommandTree(
                        insertCommand.MetadataWorkspace,
                        insertCommand.DataSpace,
                        insertCommand.Target,
                        finalSetClauses,
                        insertCommand.Returning);

                    interceptionContext.Result = newInsertCommand;
                    return;
                }
            }
        }
    }
}</code></pre></div></figure>

<p>The most important piece of code is where we create the set clause. To further explain this is an object representation of a SQL pair values like INSERT INTO TABLE (TenantId) VALUE (the value of tenantId). After doing this we filter the original collection of set clause and remove any possible existence of the same set clause. As a final step we create a new insert command by assigning the original values and replacing only the set clause. The interception ends by setting the result explicitly.</p>
<hr>
<h4 id="Modification-of-update-command"><a href="#Modification-of-update-command" class="headerlink" title="Modification of update command"></a>Modification of update command</h4><p>Now we have to modify any update command that is sent to the database and remove any change in the value of tenantId and add an extra where statement based on the tenantId. So after the interception any SQL update command is going to have an extra and statement like AND TenantId &#x3D; ‘value of tenantId’.</p>
<figure class="codeblock codeblock--tabbed"><figcaption><span>Update command interceptor</span><ul class="tabs"><li class="tab active">cs</li></ul></figcaption><div class="tabs-content"><pre style="display: block;"><code>public class TenantCommandTreeInterceptor : IDbCommandTreeInterceptor {
    public void TreeCreated(DbCommandTreeInterceptionContext interceptionContext) {
        if (interceptionContext.OriginalResult.DataSpace == DataSpace.SSpace) {
            // Check that there is an authenticated user in this context
            var identity = Thread.CurrentPrincipal.Identity as ClaimsIdentity;
            if (identity == null){
                return;
            }
            var userIdclaim = identity.Claims.SingleOrDefault(c =&gt; c.Type == ClaimTypes.NameIdentifier);
            if (userIdclaim == null) {
                return;
            }
            var userId = userIdclaim.Value;
            var updateCommand = interceptionContext.Result as DbUpdateCommandTree;
            if (updateCommand != null) {
                var column = TenantAwareAttribute.GetTenantColumnName(updateCommand.Target.VariableType.EdmType);
                if (!string.IsNullOrEmpty(column)){
                    // Create the variable reference in order to create the property
                    var variableReference = DbExpressionBuilder.Variable(updateCommand.Target.VariableType,
                        updateCommand.Target.VariableName);
                    // Create the property to which will assign the correct value
                    var tenantProperty = DbExpressionBuilder.Property(variableReference, column);
                    // Create the tenantId where predicate, object representation of sql where tenantId = value statement
                    var tenantIdWherePredicate = DbExpressionBuilder.Equal(tenantProperty, DbExpression.FromString(userId));

                    // Remove potential assignment of tenantId for extra safety
                    var filteredSetClauses =
                        updateCommand.SetClauses.Cast&lt;DbSetClause&gt;()
                            .Where(sc =&gt; ((DbPropertyExpression)sc.Property).Property.Name != column);

                    // Construct the final clauses, object representation of sql insert command values
                    var finalSetClauses =
                        new ReadOnlyCollection&lt;DbModificationClause&gt;(new List&lt;DbModificationClause&gt;(filteredSetClauses));

                    // The initial predicate is the sql where statement
                    var initialPredicate = updateCommand.Predicate;
                    // Add to the initial statement the tenantId statement which translates in sql AND TenantId = 'value'
                    var finalPredicate = initialPredicate.And(tenantIdWherePredicate);

                    var newUpdateCommand = new DbUpdateCommandTree(
                        updateCommand.MetadataWorkspace,
                        updateCommand.DataSpace,
                        updateCommand.Target,
                        finalPredicate,
                        finalSetClauses,
                        updateCommand.Returning);

                    interceptionContext.Result = newUpdateCommand;
                    return;
                }
            }
        }
    }
}</code></pre></div></figure>

<p>The first part of the code is exactly the same as the interception in insert command. The only difference here is that we don’t create another set clause but a predicate which is the object representation of the SQL And statement. We explicitly do a logical AND with the original predicate and assign the final predicate in the new update command we construct.</p>
<hr>
<h4 id="Modification-of-delete-command"><a href="#Modification-of-delete-command" class="headerlink" title="Modification of delete command"></a>Modification of delete command</h4><p>The last piece to finish the puzzle is to modify the delete command before travelling to the database. The goal is exactly the same with update command. We want to append an extra where SQL statement in all delete commands. The code is also the same as in update command.</p>
<figure class="codeblock codeblock--tabbed"><figcaption><span>Delete command interceptor</span><ul class="tabs"><li class="tab active">cs</li></ul></figcaption><div class="tabs-content"><pre style="display: block;"><code>public class TenantCommandTreeInterceptor : IDbCommandTreeInterceptor {
    public void TreeCreated(DbCommandTreeInterceptionContext interceptionContext) {
        if (interceptionContext.OriginalResult.DataSpace == DataSpace.SSpace) {
            // Check that there is an authenticated user in this context
            var identity = Thread.CurrentPrincipal.Identity as ClaimsIdentity;
            if (identity == null){
                return;
            }
            var userIdclaim = identity.Claims.SingleOrDefault(c =&gt; c.Type == ClaimTypes.NameIdentifier);
            if (userIdclaim == null) {
                return;
            }
            var userId = userIdclaim.Value;

            var deleteCommand = interceptionContext.Result as DbDeleteCommandTree;
            if (deleteCommand != null){
                var column = TenantAwareAttribute.GetTenantColumnName(deleteCommand.Target.VariableType.EdmType);
                if (!string.IsNullOrEmpty(column)){
                    // Create the variable reference in order to create the property
                    var variableReference = DbExpressionBuilder.Variable(deleteCommand.Target.VariableType,
                        deleteCommand.Target.VariableName);
                    // Create the property to which will assign the correct value
                    var tenantProperty = DbExpressionBuilder.Property(variableReference, column);
                    var tenantIdWherePredicate = DbExpressionBuilder.Equal(tenantProperty, DbExpression.FromString(userId));

                    // The initial predicate is the sql where statement
                    var initialPredicate = deleteCommand.Predicate;
                    // Add to the initial statement the tenantId statement which translates in sql AND TenantId = 'value'
                    var finalPredicate = initialPredicate.And(tenantIdWherePredicate);

                    var newDeleteCommand = new DbDeleteCommandTree(
                        deleteCommand.MetadataWorkspace,
                        deleteCommand.DataSpace,
                        deleteCommand.Target,
                        finalPredicate);

                    interceptionContext.Result = newDeleteCommand;
                    return ;
                }
            }
        }
    }
}</code></pre></div></figure>

<p>We create manually again a predicate and do a logical AND with the original predicate of the command. After this we creating a new delete command and assign it as the interception result. There is no need to create different interceptors class per command of course. We can combine all of them in just one class as you can see in <a target="_blank" rel="noopener" href="https://github.com/xabikos/EfMultitenant/blob/master/Multitenant.Interception/Infrastructure/TenantCommandTreeInterceptor.cs">this example</a>.</p>
<hr>
<h4 id="Final-thoughts"><a href="#Final-thoughts" class="headerlink" title="Final thoughts"></a>Final thoughts</h4><p>This was the last part of a series of posts. You can find the first part <a href="/2014/11/17/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-1/">here</a> and the second <a href="/2014/11/18/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-2/">here</a>. I hope that these posts will become useful to other developers as this is the way we solved the multi tenancy data access problem in the project I am currently working on. Any comments or thoughts to improve the code are more than welcome. As I mentioned in the previous posts I have a public <a target="_blank" rel="noopener" href="https://github.com/xabikos/EfMultitenant/">Github repository</a> that contains a full project with the demonstrated code.</p>
<h3 id="Part-1"><a href="#Part-1" class="headerlink" title="Part 1"></a><a href="/2014/11/17/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-1/">Part 1</a></h3><h3 id="Part-2"><a href="#Part-2" class="headerlink" title="Part 2"></a><a href="/2014/11/18/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-2/">Part 2</a></h3>
            


        </div>
    </div>
    <div id="post-footer" class="post-footer main-content-wrap">
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">TAGGED IN</span><br/>
                
    <a class="tag tag--primary tag--small t-none-link" href="/tags/code-first/" rel="tag">code first</a> <a class="tag tag--primary tag--small t-none-link" href="/tags/entity-framework/" rel="tag">entity framework</a> <a class="tag tag--primary tag--small t-none-link" href="/tags/interceptors/" rel="tag">interceptors</a> <a class="tag tag--primary tag--small t-none-link" href="/tags/multi-tenant/" rel="tag">multi-tenant</a>

            </div>
        
        
            <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2014/12/02/My-participation-in-ItProDevConnections-2014/"
                    data-tooltip="My participation in ItProDevConnections 2014"
                    aria-label="PREVIOUS: My participation in ItProDevConnections 2014"
                >
                    
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2014/11/18/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-2/"
                    data-tooltip="Create a multitenant application with Entity Framework Code First - Part 2"
                    aria-label="NEXT: Create a multitenant application with Entity Framework Code First - Part 2"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="Share this post"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://xabikos.com/2014/11/19/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-3/"
                    title="Share on Facebook"
                    aria-label="Share on Facebook"
                >
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=https://xabikos.com/2014/11/19/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-3/"
                    title="Share on Twitter"
                    aria-label="Share on Twitter"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
                <li class="post-action">
                    <a
                        class="post-action-btn btn btn--default"
                        href="#disqus_thread"
                        aria-label="Leave a comment"
                    >
                        <i class="fa fa-comment"></i>
                    </a>
                </li>
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="Back to top">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


        
        
            
                <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
            
        
    </div>
</article>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2024 Babis Karypidis. All Rights Reserved.
    </span>
</footer>

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="5">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2014/12/02/My-participation-in-ItProDevConnections-2014/"
                    data-tooltip="My participation in ItProDevConnections 2014"
                    aria-label="PREVIOUS: My participation in ItProDevConnections 2014"
                >
                    
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2014/11/18/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-2/"
                    data-tooltip="Create a multitenant application with Entity Framework Code First - Part 2"
                    aria-label="NEXT: Create a multitenant application with Entity Framework Code First - Part 2"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="Share this post"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://xabikos.com/2014/11/19/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-3/"
                    title="Share on Facebook"
                    aria-label="Share on Facebook"
                >
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=https://xabikos.com/2014/11/19/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-3/"
                    title="Share on Twitter"
                    aria-label="Share on Twitter"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
                <li class="post-action">
                    <a
                        class="post-action-btn btn btn--default"
                        href="#disqus_thread"
                        aria-label="Leave a comment"
                    >
                        <i class="fa fa-comment"></i>
                    </a>
                </li>
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="Back to top">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


                </div>
                
    <div id="share-options-bar" class="share-options-bar" data-behavior="5">
        <i id="btn-close-shareoptions" class="fa fa-times"></i>
        <ul class="share-options">
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://www.facebook.com/sharer/sharer.php?u=https://xabikos.com/2014/11/19/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-3/"
                        aria-label="Share on Facebook"
                    >
                        <i class="fab fa-facebook" aria-hidden="true"></i><span>Share on Facebook</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://twitter.com/intent/tweet?text=https://xabikos.com/2014/11/19/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-3/"
                        aria-label="Share on Twitter"
                    >
                        <i class="fab fa-twitter" aria-hidden="true"></i><span>Share on Twitter</span>
                    </a>
                </li>
            
        </ul>
    </div>


            
        </div>
        


    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <img id="about-card-picture" src="https://www.gravatar.com/avatar/7c9ee05396641133c8d505197fc17cc5?s=110" alt="Author&#39;s picture"/>
        
            <h4 id="about-card-name">Babis Karypidis</h4>
        
            <div id="about-card-bio"><p>author.bio</p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>author.job</p>

            </div>
        
        
            <div id="about-card-location">
                <i class="fa fa-map-marker-alt"></i>
                <br/>
                Thessaloniki, Greece
            </div>
        
    </div>
</div>

        
        
<div id="cover" style="background-image:url('/assets/images/cover.jpg');"></div>
        <!--SCRIPTS-->

<script src="/assets/js/script-9xh1uuvzj9epxjrwi1ftdf05eawvprhb9onoygse3kk2ycl8ua9fcrxverfe.min.js"></script>

<!--SCRIPTS END-->


    
        <script>
          var disqus_config = function() {
            this.page.url = 'https://xabikos.com/2014/11/19/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-3/';
              
            this.page.identifier = '2014/11/19/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-3/';
              
          };
          (function() {
            var d = document, s = d.createElement('script');
            var disqus_shortname = 'xabikos';
            s.src = '//' + disqus_shortname + '.disqus.com/embed.js';

            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
          })();
        </script>
    




    </body>
</html>
