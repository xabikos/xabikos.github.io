
<!DOCTYPE html>
<html lang="en">
    
<head>
    <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" >
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Web development with asp.net and React.js">
    <title>Create a multitenant application with Entity Framework Code First - Part 3 - Web development with asp.net and React.js</title>
    <meta name="author" content="Babis Karypidis">
    
        <meta name="keywords" content="entity framework,multitenant,code first">
    
    
    
        <link rel="alternate" type="application/atom+xml" title="RSS" href="/atom.xml">
    
    <meta name="description" content="Connection with previous postsThis is the last post of the series of how we can use Entity Framework Code First to create a multitenant application. You are requested first to read Part 1 where there">
<meta property="og:type" content="blog">
<meta property="og:title" content="Create a multitenant application with Entity Framework Code First - Part 3">
<meta property="og:url" content="http://xabikostest.github.io/2014/11/19/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-3/index.html">
<meta property="og:site_name" content="Web development with asp.net and React.js">
<meta property="og:description" content="Connection with previous postsThis is the last post of the series of how we can use Entity Framework Code First to create a multitenant application. You are requested first to read Part 1 where there">
<meta property="og:updated_time" content="2016-04-27T16:49:34.101Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Create a multitenant application with Entity Framework Code First - Part 3">
<meta name="twitter:description" content="Connection with previous postsThis is the last post of the series of how we can use Entity Framework Code First to create a multitenant application. You are requested first to read Part 1 where there">
<meta name="twitter:creator" content="@xabikos">
    
    
        
    
    
        <meta property="og:image" content="http://www.gravatar.com/avatar/7c9ee05396641133c8d505197fc17cc5?s=640"/>
    
    
    
    
    <!--STYLES-->
    <link rel="stylesheet" href="/assets/css/style-quwccsthbllipo6252snb2tfkddvrsp1eczkytpz3vmxpsb6nwodixemlkux.min.css" type="text/css">
    <!--STYLES END-->
    
    <script type="text/javascript">
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-56484404-1']);
        _gaq.push(['_trackPageview']);
        (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
    </script>

    
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    
        
    

<header id="header" data-behavior="4">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <h1 class="header-title">
        <a class="header-title-link" href="/ ">Web development with asp.net and React.js</a>
    </h1>
    
        
            <a  class="header-right-picture "
                href="/#about">
        
        
            <img class="header-picture" src="http://www.gravatar.com/avatar/7c9ee05396641133c8d505197fc17cc5?s=90"/>
        
        </a>
    
</header>

            <!-- Define author's picture -->


    

<nav id="sidebar" data-behavior="4">
    
        <div class="sidebar-profile">
            <a href="/#about">
                    <img class="sidebar-profile-picture" src="http://www.gravatar.com/avatar/7c9ee05396641133c8d505197fc17cc5?s=110"/>
            </a>
            <span class="sidebar-profile-name">Babis Karypidis</span>
        </div>
    
    
        <ul class="sidebar-buttons">
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/ "
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-home"></i>
                    <span class="sidebar-button-desc">Home</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/all-categories"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
                    <span class="sidebar-button-desc">Categories</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/all-tags"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
                    <span class="sidebar-button-desc">Tags</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/#about"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-question"></i>
                    <span class="sidebar-button-desc">About</span>
                </a>
        </li>
        
    </ul>
    
        <ul class="sidebar-buttons">
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link " href="https://github.com/xabikos" target="_blank">
                
                    <i class="sidebar-button-icon fa fa-lg fa-github"></i>
                    <span class="sidebar-button-desc">GitHub</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link " href="https://twitter.com/xabikos" target="_blank">
                
                    <i class="sidebar-button-icon fa fa-lg fa-twitter"></i>
                    <span class="sidebar-button-desc">Twitter</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link " href="https://www.linkedin.com/in/charalamposkarypidis/" target="_blank">
                
                    <i class="sidebar-button-icon fa fa-lg fa-linkedin"></i>
                    <span class="sidebar-button-desc">LinkedIn</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link " href="mailto:xaralaboskaripidis@gmail.com" target="_blank">
                
                    <i class="sidebar-button-icon fa fa-lg fa-envelope-o"></i>
                    <span class="sidebar-button-desc">Mail</span>
                </a>
        </li>
        
    </ul>
    
        <ul class="sidebar-buttons">
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/atom.xml"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-rss"></i>
                    <span class="sidebar-button-desc">RSS</span>
                </a>
        </li>
        
    </ul>
    
</nav>

            
            <div id="main" data-behavior="4"
                 class="
                        hasCoverMetaIn
                        ">
                
<article class="post" itemscope itemType="http://schema.org/BlogPosting">
    
    
        <div class="post-header main-content-wrap text-left">
    
        <h1 class="post-title" itemprop="headline">
            Create a multitenant application with Entity Framework Code First - Part 3
        </h1>
    
    <div class="post-meta">
    <time itemprop="datePublished" content="Wed Nov 19 2014 20:15:00 GMT+0100">
	
		    Nov 19, 2014
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/multitenant/">multitenant</a>, <a class="category-link" href="/categories/multitenant/application-design/">application design</a>, <a class="category-link" href="/categories/multitenant/application-design/software-as-a-service/">software as a service</a>


    
</div>
</div>
    
    <div class="post-content markdown" itemprop="articleBody">
        <div class="main-content-wrap">
            <h4 id="Connection-with-previous-posts"><a href="#Connection-with-previous-posts" class="headerlink" title="Connection with previous posts"></a>Connection with previous posts</h4><p>This is the last post of the series of how we can use Entity Framework Code First to create a multitenant application. You are requested first to read <a href="/2014/11/17/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-1/">Part 1</a> where there is an introduction in the problem we are trying to solve and some infrastructure code required to continue. <a href="/2014/11/18/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-2/">Part 2</a> describes the query filtering that is happening automatically in the entire application. In this post I am going to show how we can use the CommandTree interceptor in order to modify the insert, update and delete commands. The idea of implement something like this came to my mind after watching <a href="http://romiller.com/" target="_blank" rel="external">Rowan Millerâ€™s</a> excellent <a href="http://channel9.msdn.com/Events/TechEd/NorthAmerica/2014/DEV-B417#fbid=" target="_blank" rel="external">session</a> in North America TechEd, which I highly recommend you to watch.<br><a id="more"></a></p>
<hr>
<h4 id="Modification-of-insert-command"><a href="#Modification-of-insert-command" class="headerlink" title="Modification of insert command"></a>Modification of insert command</h4><p>Letâ€™s start by presenting the code of insert command which is probably the simplest case. What we want to achieve is to always assign the correct TenantId when saving an entity that has this property. I have to remind here that Message class has a private set in TenantId property so there is no way to assign it from the code base.<br><figure class="codeblock codeblock--tabbed"><figcaption><span>Insert command interceptor</span><ul class="tabs"><li class="tab active">cs</li></ul></figcaption><div class="tabs-content"><figure class="highlight cs" style="display: block;"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TenantCommandTreeInterceptor</span> : <span class="title">IDbCommandTreeInterceptor</span> {</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">TreeCreated</span>(<span class="params">DbCommandTreeInterceptionContext interceptionContext</span>) </span>{</span><br><span class="line">        <span class="keyword">if</span> (interceptionContext.OriginalResult.DataSpace == DataSpace.SSpace) {</span><br><span class="line">            <span class="comment">// Check that there is an authenticated user in this context</span></span><br><span class="line">            <span class="keyword">var</span> identity = Thread.CurrentPrincipal.Identity <span class="keyword">as</span> ClaimsIdentity;</span><br><span class="line">            <span class="keyword">if</span> (identity == <span class="keyword">null</span>){</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">var</span> userIdclaim = identity.Claims.SingleOrDefault(c =&gt; c.Type == ClaimTypes.NameIdentifier);</span><br><span class="line">            <span class="keyword">if</span> (userIdclaim == <span class="keyword">null</span>) {</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">var</span> userId = userIdclaim.Value;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> insertCommand = interceptionContext.Result <span class="keyword">as</span> DbInsertCommandTree;</span><br><span class="line">            <span class="keyword">if</span> (insertCommand != <span class="keyword">null</span>) {</span><br><span class="line">                <span class="keyword">var</span> column = TenantAwareAttribute.GetTenantColumnName(insertCommand.Target.VariableType.EdmType);</span><br><span class="line">                <span class="keyword">if</span> (!<span class="keyword">string</span>.IsNullOrEmpty(column)) {</span><br><span class="line">                    <span class="comment">// Create the variable reference in order to create the property</span></span><br><span class="line">                    <span class="keyword">var</span> variableReference = DbExpressionBuilder.Variable(insertCommand.Target.VariableType,</span><br><span class="line">                        insertCommand.Target.VariableName);</span><br><span class="line">                    <span class="comment">// Create the property to which will assign the correct value</span></span><br><span class="line">                    <span class="keyword">var</span> tenantProperty = DbExpressionBuilder.Property(variableReference, column);</span><br><span class="line">                    <span class="comment">// Create the set clause, object representation of sql insert command</span></span><br><span class="line">                    <span class="keyword">var</span> tenantSetClause =</span><br><span class="line">                        DbExpressionBuilder.SetClause(tenantProperty, DbExpression.FromString(userId));</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// Remove potential assignment of tenantId for extra safety</span></span><br><span class="line">                    <span class="keyword">var</span> filteredSetClauses =</span><br><span class="line">                        insertCommand.SetClauses.Cast&lt;DbSetClause&gt;()</span><br><span class="line">                            .Where(sc =&gt; ((DbPropertyExpression)sc.Property).Property.Name != column);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// Construct the final clauses, object representation of sql insert command values</span></span><br><span class="line">                    <span class="keyword">var</span> finalSetClauses =</span><br><span class="line">                        <span class="keyword">new</span> ReadOnlyCollection&lt;DbModificationClause&gt;</span><br><span class="line">                        (<span class="keyword">new</span> List&lt;DbModificationClause&gt;(filteredSetClauses) {</span><br><span class="line">                            tenantSetClause</span><br><span class="line">                        });</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">var</span> newInsertCommand = <span class="keyword">new</span> DbInsertCommandTree(</span><br><span class="line">                        insertCommand.MetadataWorkspace,</span><br><span class="line">                        insertCommand.DataSpace,</span><br><span class="line">                        insertCommand.Target,</span><br><span class="line">                        finalSetClauses,</span><br><span class="line">                        insertCommand.Returning);</span><br><span class="line"></span><br><span class="line">                    interceptionContext.Result = newInsertCommand;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div></figure></p>
<p>The most important piece of code is where we create the set clause. To further explain this is an object representation of a SQL pair values like INSERT INTO TABLE (TenantId) VALUE (the value of tenantId). After doing this we filter the original collection of set clause and remove any possible existence of the same set clause. As a final step we create a new insert command by assigning the original values and replacing only the set clause. The interception ends by setting the result explicitly.</p>
<hr>
<h4 id="Modification-of-update-command"><a href="#Modification-of-update-command" class="headerlink" title="Modification of update command"></a>Modification of update command</h4><p>Now we have to modify any update command that is sent to the database and remove any change in the value of tenantId and add an extra where statement based on the tenantId. So after the interception any SQL update command is going to have an extra and statement like AND TenantId = â€˜value of tenantIdâ€™.<br><figure class="codeblock codeblock--tabbed"><figcaption><span>Update command interceptor</span><ul class="tabs"><li class="tab active">cs</li></ul></figcaption><div class="tabs-content"><figure class="highlight cs" style="display: block;"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TenantCommandTreeInterceptor</span> : <span class="title">IDbCommandTreeInterceptor</span> {</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">TreeCreated</span>(<span class="params">DbCommandTreeInterceptionContext interceptionContext</span>) </span>{</span><br><span class="line">        <span class="keyword">if</span> (interceptionContext.OriginalResult.DataSpace == DataSpace.SSpace) {</span><br><span class="line">            <span class="comment">// Check that there is an authenticated user in this context</span></span><br><span class="line">            <span class="keyword">var</span> identity = Thread.CurrentPrincipal.Identity <span class="keyword">as</span> ClaimsIdentity;</span><br><span class="line">            <span class="keyword">if</span> (identity == <span class="keyword">null</span>){</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">var</span> userIdclaim = identity.Claims.SingleOrDefault(c =&gt; c.Type == ClaimTypes.NameIdentifier);</span><br><span class="line">            <span class="keyword">if</span> (userIdclaim == <span class="keyword">null</span>) {</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">var</span> userId = userIdclaim.Value;</span><br><span class="line">            <span class="keyword">var</span> updateCommand = interceptionContext.Result <span class="keyword">as</span> DbUpdateCommandTree;</span><br><span class="line">            <span class="keyword">if</span> (updateCommand != <span class="keyword">null</span>) {</span><br><span class="line">                <span class="keyword">var</span> column = TenantAwareAttribute.GetTenantColumnName(updateCommand.Target.VariableType.EdmType);</span><br><span class="line">                <span class="keyword">if</span> (!<span class="keyword">string</span>.IsNullOrEmpty(column)){</span><br><span class="line">                    <span class="comment">// Create the variable reference in order to create the property</span></span><br><span class="line">                    <span class="keyword">var</span> variableReference = DbExpressionBuilder.Variable(updateCommand.Target.VariableType,</span><br><span class="line">                        updateCommand.Target.VariableName);</span><br><span class="line">                    <span class="comment">// Create the property to which will assign the correct value</span></span><br><span class="line">                    <span class="keyword">var</span> tenantProperty = DbExpressionBuilder.Property(variableReference, column);</span><br><span class="line">                    <span class="comment">// Create the tenantId where predicate, object representation of sql where tenantId = value statement</span></span><br><span class="line">                    <span class="keyword">var</span> tenantIdWherePredicate = DbExpressionBuilder.Equal(tenantProperty, DbExpression.FromString(userId));</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// Remove potential assignment of tenantId for extra safety</span></span><br><span class="line">                    <span class="keyword">var</span> filteredSetClauses =</span><br><span class="line">                        updateCommand.SetClauses.Cast&lt;DbSetClause&gt;()</span><br><span class="line">                            .Where(sc =&gt; ((DbPropertyExpression)sc.Property).Property.Name != column);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// Construct the final clauses, object representation of sql insert command values</span></span><br><span class="line">                    <span class="keyword">var</span> finalSetClauses =</span><br><span class="line">                        <span class="keyword">new</span> ReadOnlyCollection&lt;DbModificationClause&gt;(<span class="keyword">new</span> List&lt;DbModificationClause&gt;(filteredSetClauses));</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// The initial predicate is the sql where statement</span></span><br><span class="line">                    <span class="keyword">var</span> initialPredicate = updateCommand.Predicate;</span><br><span class="line">                    <span class="comment">// Add to the initial statement the tenantId statement which translates in sql AND TenantId = 'value'</span></span><br><span class="line">                    <span class="keyword">var</span> finalPredicate = initialPredicate.And(tenantIdWherePredicate);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">var</span> newUpdateCommand = <span class="keyword">new</span> DbUpdateCommandTree(</span><br><span class="line">                        updateCommand.MetadataWorkspace,</span><br><span class="line">                        updateCommand.DataSpace,</span><br><span class="line">                        updateCommand.Target,</span><br><span class="line">                        finalPredicate,</span><br><span class="line">                        finalSetClauses,</span><br><span class="line">                        updateCommand.Returning);</span><br><span class="line"></span><br><span class="line">                    interceptionContext.Result = newUpdateCommand;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div></figure></p>
<p>The first part of the code is exactly the same as the interception in insert command. The only difference here is that we donâ€™t create another set clause but a predicate which is the object representation of the SQL And statement. We explicitly do a logical AND with the original predicate and assign the final predicate in the new update command we construct.</p>
<hr>
<h4 id="Modification-of-delete-command"><a href="#Modification-of-delete-command" class="headerlink" title="Modification of delete command"></a>Modification of delete command</h4><p>The last piece to finish the puzzle is to modify the delete command before travelling to the database. The goal is exactly the same with update command. We want to append an extra where SQL statement in all delete commands. The code is also the same as in update command.</p>
<figure class="codeblock codeblock--tabbed"><figcaption><span>Delete command interceptor</span><ul class="tabs"><li class="tab active">cs</li></ul></figcaption><div class="tabs-content"><figure class="highlight cs" style="display: block;"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TenantCommandTreeInterceptor</span> : <span class="title">IDbCommandTreeInterceptor</span> {</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">TreeCreated</span>(<span class="params">DbCommandTreeInterceptionContext interceptionContext</span>) </span>{</span><br><span class="line">        <span class="keyword">if</span> (interceptionContext.OriginalResult.DataSpace == DataSpace.SSpace) {</span><br><span class="line">            <span class="comment">// Check that there is an authenticated user in this context</span></span><br><span class="line">            <span class="keyword">var</span> identity = Thread.CurrentPrincipal.Identity <span class="keyword">as</span> ClaimsIdentity;</span><br><span class="line">            <span class="keyword">if</span> (identity == <span class="keyword">null</span>){</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">var</span> userIdclaim = identity.Claims.SingleOrDefault(c =&gt; c.Type == ClaimTypes.NameIdentifier);</span><br><span class="line">            <span class="keyword">if</span> (userIdclaim == <span class="keyword">null</span>) {</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">var</span> userId = userIdclaim.Value;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> deleteCommand = interceptionContext.Result <span class="keyword">as</span> DbDeleteCommandTree;</span><br><span class="line">            <span class="keyword">if</span> (deleteCommand != <span class="keyword">null</span>){</span><br><span class="line">                <span class="keyword">var</span> column = TenantAwareAttribute.GetTenantColumnName(deleteCommand.Target.VariableType.EdmType);</span><br><span class="line">                <span class="keyword">if</span> (!<span class="keyword">string</span>.IsNullOrEmpty(column)){</span><br><span class="line">                    <span class="comment">// Create the variable reference in order to create the property</span></span><br><span class="line">                    <span class="keyword">var</span> variableReference = DbExpressionBuilder.Variable(deleteCommand.Target.VariableType,</span><br><span class="line">                        deleteCommand.Target.VariableName);</span><br><span class="line">                    <span class="comment">// Create the property to which will assign the correct value</span></span><br><span class="line">                    <span class="keyword">var</span> tenantProperty = DbExpressionBuilder.Property(variableReference, column);</span><br><span class="line">                    <span class="keyword">var</span> tenantIdWherePredicate = DbExpressionBuilder.Equal(tenantProperty, DbExpression.FromString(userId));</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// The initial predicate is the sql where statement</span></span><br><span class="line">                    <span class="keyword">var</span> initialPredicate = deleteCommand.Predicate;</span><br><span class="line">                    <span class="comment">// Add to the initial statement the tenantId statement which translates in sql AND TenantId = 'value'</span></span><br><span class="line">                    <span class="keyword">var</span> finalPredicate = initialPredicate.And(tenantIdWherePredicate);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">var</span> newDeleteCommand = <span class="keyword">new</span> DbDeleteCommandTree(</span><br><span class="line">                        deleteCommand.MetadataWorkspace,</span><br><span class="line">                        deleteCommand.DataSpace,</span><br><span class="line">                        deleteCommand.Target,</span><br><span class="line">                        finalPredicate);</span><br><span class="line"></span><br><span class="line">                    interceptionContext.Result = newDeleteCommand;</span><br><span class="line">                    <span class="keyword">return</span> ;</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div></figure>
<p>We create manually again a predicate and do a logical AND with the original predicate of the command. After this we creating a new delete command and assign it as the interception result. There is no need to create different interceptors class per command of course. We can combine all of them in just one class as you can see in <a href="https://github.com/xabikos/EfMultitenant/blob/master/Multitenant.Interception/Infrastructure/TenantCommandTreeInterceptor.cs" target="_blank" rel="external">this example</a>.</p>
<hr>
<h4 id="Final-thoughts"><a href="#Final-thoughts" class="headerlink" title="Final thoughts"></a>Final thoughts</h4><p>This was the last part of a series of posts. You can find the first part <a href="/2014/11/17/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-1/">here</a> and the second <a href="/2014/11/18/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-2/">here</a>. I hope that these posts will become useful to other developers as this is the way we solved the multi tenancy data access problem in the project I am currently working on. Any comments or thoughts to improve the code are more than welcome. As I mentioned in the previous posts I have a public <a href="https://github.com/xabikos/EfMultitenant/" target="_blank" rel="external">Github repository</a> that contains a full project with the demonstrated code.</p>
<h3 id="Part-1"><a href="#Part-1" class="headerlink" title="Part 1"></a><a href="/2014/11/17/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-1/">Part 1</a></h3><h3 id="Part-2"><a href="#Part-2" class="headerlink" title="Part 2"></a><a href="/2014/11/18/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-2/">Part 2</a></h3>
            
        </div>
    </div>
    <div id="post-footer" class="post-footer main-content-wrap">
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">TAGGED IN</span><br/>
                
    <a class="tag tag--primary tag--small t-link" href="/tags/code-first/">code first</a> <a class="tag tag--primary tag--small t-link" href="/tags/entity-framework/">entity framework</a> <a class="tag tag--primary tag--small t-link" href="/tags/interceptors/">interceptors</a> <a class="tag tag--primary tag--small t-link" href="/tags/multi-tenant/">multi-tenant</a>

            </div>
        
        <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2014/12/02/My-participation-in-ItProDevConnections-2014/"  data-tooltip="My participation in ItProDevConnections 2014">
                
                    <i class="fa fa-angle-left"></i>
                    <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                </a>
            </li>
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2014/11/18/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-2/" data-tooltip="Create a multitenant application with Entity Framework Code First - Part 2">
                
                    <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                    <i class="fa fa-angle-right"></i>
                </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a class="post-action-btn btn btn--default btn-open-shareoptions"  href="#btn-open-shareoptions">
                <i class="fa fa-share-alt"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=http://xabikostest.github.io/2014/11/19/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-3/">
                <i class="fa fa-google-plus"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://xabikostest.github.io/2014/11/19/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-3/">
                <i class="fa fa-facebook-official"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=http://xabikostest.github.io/2014/11/19/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-3/">
                <i class="fa fa-twitter"></i>
            </a>
        </li>
        
            <li class="post-action">
                <a class="post-action-btn btn btn--default" href="#disqus_thread">
                    <i class="fa fa-comment-o"></i>
                </a>
            </li>
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#">
            
                <i class="fa fa-list"></i>
            </a>
        </li>
    </ul>
</div>


        
            
                <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
            
        
    </div>
</article>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2016 Babis Karypidis. All Rights Reserved.
    </span>
</footer>

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="4">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2014/12/02/My-participation-in-ItProDevConnections-2014/"  data-tooltip="My participation in ItProDevConnections 2014">
                
                    <i class="fa fa-angle-left"></i>
                    <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                </a>
            </li>
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2014/11/18/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-2/" data-tooltip="Create a multitenant application with Entity Framework Code First - Part 2">
                
                    <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                    <i class="fa fa-angle-right"></i>
                </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a class="post-action-btn btn btn--default btn-open-shareoptions"  href="#btn-open-shareoptions">
                <i class="fa fa-share-alt"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=http://xabikostest.github.io/2014/11/19/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-3/">
                <i class="fa fa-google-plus"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://xabikostest.github.io/2014/11/19/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-3/">
                <i class="fa fa-facebook-official"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=http://xabikostest.github.io/2014/11/19/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-3/">
                <i class="fa fa-twitter"></i>
            </a>
        </li>
        
            <li class="post-action">
                <a class="post-action-btn btn btn--default" href="#disqus_thread">
                    <i class="fa fa-comment-o"></i>
                </a>
            </li>
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#">
            
                <i class="fa fa-list"></i>
            </a>
        </li>
    </ul>
</div>


                </div>
                <div id="share-options-bar" class="share-options-bar" data-behavior="4">
    <ul class="share-options">
        <li class="share-option">
            <a class="share-option-btn" target="new" href="https://plus.google.com/share?url=http://xabikostest.github.io/2014/11/19/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-3/">
                <i class="fa fa-google-plus"></i><span class="">Share on Google Plus</span>
            </a>
        </li>
        <li class="share-option">
            <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://xabikostest.github.io/2014/11/19/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-3/">
                <i class="fa fa-facebook-official"></i><span>Share on Facebook</span>
            </a>
        </li>
        <li class="share-option">
            <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=http://xabikostest.github.io/2014/11/19/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-3/">
                <i class="fa fa-twitter"></i><span>Share on Twitter</span>
            </a>
        </li>
    </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>
            
        </div>
        


    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-remove"></i>
        </div>
        
            <img id="about-card-picture" src="http://www.gravatar.com/avatar/7c9ee05396641133c8d505197fc17cc5?s=110"/>
        
            <h4 id="about-card-name">Babis Karypidis</h4>
        
            <h5 id="about-card-bio"><p>Hi, I am Babis Karypidis, a Greek software engineer who tries to fit other activities, except development, in his life.</p>
</h5>
        
        
            <h5 id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>Freelance Software Engineer focusing on .NET, Azure and React.js</p>

            </h5>
        
        
            <h5 id="about-card-location">
                <i class="fa fa-map-marker"></i>
                <br/>
                Brussels, Belgium
            </h5>
        
    </div>
</div>

        
<div id="cover" style="background-image:url('https://globalazurereport.blob.core.windows.net/personalblog/web_development_top.jpg');"></div>
    </body>
    <!--SCRIPTS-->
<script src="/assets/js/scrip-rjanlllosg30d03qrddpwrs6wqf4k3v0bbo68hiifuvthyhqfefx2htcagu0.min.js" type="text/javascript"></script>
<!--SCRIPTS END-->

    
        <script>
             var disqus_config = function () {
                 this.page.url = 'http://xabikostest.github.io/2014/11/19/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-3/';
                 
                    this.page.identifier = '2014/11/19/Create-a-multitenant-application-with-Entity-Framework-Code-First-Part-3/';
                                  
             };
            (function() {
                var d = document, s = d.createElement('script');
                var disqus_shortname = 'xabikos';
                s.src = '//' + disqus_shortname + '.disqus.com/embed.js';

                s.setAttribute('data-timestamp', +new Date());
                (d.head || d.body).appendChild(s);
            })();
        </script>
    



</html>
